<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì£¼ê°„ í‰ê·  ê²°ì‚°</title>

  <link rel="stylesheet" href="header_standard.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 1100px; margin: 40px auto; padding: 20px; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 20px; border: 1px solid #2a3242; margin-bottom: 20px; }
    
    h2 { color: #f4c430; margin-top: 0; }
    .control-panel { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; background: #121721; padding: 15px; border-radius: 8px; }
    .control-panel input[type="number"] { padding: 10px; border-radius: 8px; border: 1px solid #444; background: #2a3242; color: #fff; width: 150px;}
    button { padding: 10px 18px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-calc { background: #00e676; color: #000; }
    .btn-calc:hover { background: #00c853; }
    
    /* ê²°ì‚° í…Œì´ë¸” */
    table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: center; }
    th, td { border: 1px solid #2a3242; padding: 12px 8px; }
    th { background: #121721; color: #f4c430; font-weight: bold; }
    .highlight { color: #00e676; font-weight: bold; }
    .total-row { background: rgba(244, 196, 48, 0.1); font-weight: bold; color: #f4c430; }

    .admin-only { display: none; background: #2a1515; border-color: #ff5252; margin-top: 20px; }
    .admin-only h3 { color: #ff5252; margin-top: 0; }
    .btn-save { background: #ff5252; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>ğŸ’° ì£¼ê°„ í‰ê·  ê²°ì‚° ë° ë¶„ë°°</h2>
      <p style="color:#aaa;">ì¼ì£¼ì¼(7ì¼) ë™ì•ˆì˜ ì ìˆ˜ í•©ì‚°ì„ 7ë¡œ ë‚˜ëˆˆ <b>'ì¼ì¼ í‰ê·  ì ìˆ˜'</b>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë°°í•©ë‹ˆë‹¤.</p>
      
      <div class="control-panel">
        <div>
          <label style="display:block; font-size:12px; margin-bottom:4px; color:#aaa;">ë¶„ë°°í•  ì´ ìƒì/ê³¨ë“œëŸ‰</label>
          <input type="number" id="totalReward" placeholder="ì˜ˆ: 10000" min="0">
        </div>
        <button class="btn-calc" onclick="calculateWeekly()" style="margin-top: 18px;">ì§‘ê³„ ë° ë¶„ë°° ê³„ì‚°í•˜ê¸°</button>
      </div>
      
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ë‹‰ë„¤ì„</th>
              <th>ì´ê³„ (1ì£¼í‰ê· )</th>
              <th>ëª…ê²° (1ì£¼í‰ê· )</th>
              <th>í™œì•½ë„ (1ì£¼í‰ê· )</th>
              <th>í•©ì‚° í‰ê· ì ìˆ˜</th>
              <th>ê¸°ì—¬ ì§€ë¶„ìœ¨</th>
              <th style="color:#00e676;">ì˜ˆìƒ ë¶„ë°°ëŸ‰</th>
            </tr>
          </thead>
          <tbody id="resultTable">
            <tr><td colspan="7" style="padding:30px; color:#aaa;">ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§‘ê³„ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card admin-only" id="adminBox">
      <h3>ğŸ› ï¸ ê´€ë¦¬ì ê²°ì‚° í™•ì •</h3>
      <p>ìœ„ì˜ ë¶„ë°° ê²°ê³¼ë¥¼ ì´ë²ˆ ì£¼ ê³µì‹ ê¸°ë¡ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
      <button class="btn-save" onclick="finalize()">ì´ëŒ€ë¡œ ê²°ì‚° í™•ì • ë° ì´ë ¥ ì €ì¥</button>
    </div>
  </div>

  <script>
    let isAdmin = false;
    let finalWeeklyData = {};
    let totalRewardToDistribute = 0;

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("userName").textContent = data.nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;

        if (data.role === "admin" || data.role === "manager") {
          isAdmin = true;
          if(data.role === "admin") document.getElementById("adminBox").style.display = "block"; // ìµœê³ ê´€ë¦¬ìë§Œ ì €ì¥ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ ë¶„ê¸°
        }
      }
    });

    async function calculateWeekly() {
      const rewardInput = document.getElementById("totalReward").value;
      if (!rewardInput) return alert("ë¶„ë°°í•  ì´ ìƒì ë˜ëŠ” ê³¨ë“œëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      totalRewardToDistribute = Number(rewardInput);

      const tbody = document.getElementById("resultTable");
      tbody.innerHTML = "<tr><td colspan='7'>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
      finalWeeklyData = {};

      const usersSnap = await db.collection("users").get();
      const userMap = {};
      usersSnap.forEach(u => userMap[u.id] = u.data().nickname);

      const logsSnap = await db.collection("attendance_logs").get();
      
      let guildTotalAverageScore = 0; // ê¸¸ë“œ ì „ì²´ í•©ì‚° í‰ê·  ì ìˆ˜ (ì§€ë¶„ìœ¨ ê³„ì‚°ìš©)
      const parsedData = [];

      // 1. ë°ì´í„° ì·¨í•© ë° í‰ê·  ê³„ì‚°
      for (const userDoc of logsSnap.docs) {
        const uid = userDoc.id;
        let sumLaby = 0, sumDuel = 0, sumActivity = 0;

        const daysSnap = await userDoc.ref.collection("days").get();
        daysSnap.forEach(d => {
          const v = d.data();
          sumLaby += (v.laby || 0);
          sumDuel += (v.duel || 0);
          sumActivity += (v.activity || 0);
        });

        if (sumLaby > 0 || sumDuel > 0 || sumActivity > 0) {
          // 1ì£¼(7ì¼) ê¸°ì¤€ í‰ê·  ê³„ì‚° (ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€)
          const avgLaby = (sumLaby / 7).toFixed(1);
          const avgDuel = (sumDuel / 7).toFixed(1);
          const avgActivity = (sumActivity / 7).toFixed(1);
          
          // ê°œì¸ë³„ í•©ì‚° í‰ê·  ì ìˆ˜
          const totalAvgScore = Number(avgLaby) + Number(avgDuel) + Number(avgActivity);
          guildTotalAverageScore += totalAvgScore;

          parsedData.push({
            uid: uid,
            nickname: userMap[uid] || "ì•Œìˆ˜ì—†ìŒ",
            avgLaby: Number(avgLaby),
            avgDuel: Number(avgDuel),
            avgActivity: Number(avgActivity),
            totalAvg: totalAvgScore
          });
        }
      }

      // 2. ì§€ë¶„ìœ¨ ë° ë¶„ë°°ëŸ‰ ê³„ì‚°, í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = "";
      if (parsedData.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>ì´ë²ˆ ì£¼ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
      }

      // ì ìˆ˜ ë†’ì€ ìˆœ ì •ë ¬
      parsedData.sort((a, b) => b.totalAvg - a.totalAvg);

      parsedData.forEach(d => {
        // ì§€ë¶„ìœ¨(%) = (ê°œì¸ í•©ì‚° / ê¸¸ë“œ ì´ í•©ì‚°) * 100
        const shareRatio = guildTotalAverageScore > 0 ? (d.totalAvg / guildTotalAverageScore) : 0;
        const sharePercent = (shareRatio * 100).toFixed(2);
        
        // ìµœì¢… ë¶„ë°°ëŸ‰ = ì´ ë³´ìƒëŸ‰ * ì§€ë¶„ìœ¨ (ì†Œìˆ˜ì  ë²„ë¦¼ ì²˜ë¦¬)
        const myReward = Math.floor(totalRewardToDistribute * shareRatio);

        // í™•ì •ìš© ë°ì´í„° ì €ì¥
        finalWeeklyData[d.uid] = { nickname: d.nickname, sharePercent: sharePercent, reward: myReward };

        tbody.innerHTML += `
          <tr>
            <td><b>${d.nickname}</b></td>
            <td>${d.avgLaby}</td>
            <td>${d.avgDuel}</td>
            <td>${d.avgActivity}</td>
            <td style="color:#f4c430; font-weight:bold;">${d.totalAvg.toFixed(1)}</td>
            <td>${sharePercent}%</td>
            <td class="highlight">${myReward.toLocaleString()}</td>
          </tr>
        `;
      });

      // ì´í•©ê³„ ì¤„ ì¶”ê°€
      tbody.innerHTML += `
        <tr class="total-row">
          <td colspan="4">ê¸¸ë“œ ì´ í•©ì‚° ì ìˆ˜</td>
          <td>${guildTotalAverageScore.toFixed(1)}</td>
          <td>100.00%</td>
          <td>${totalRewardToDistribute.toLocaleString()}</td>
        </tr>
      `;
    }

    // 3. ê²°ì‚° ê¸°ë¡ íŒŒì´ì–´ë² ì´ìŠ¤ì— ì €ì¥ (history ì—°ë™ìš©)
    async function finalize() {
      if (Object.keys(finalWeeklyData).length === 0) return alert("ë¨¼ì € ì§‘ê³„ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
      if (!confirm(`ì´ ë³´ìƒ ${totalRewardToDistribute}ê°œë¡œ ê²°ì‚°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ ì´ë ¥ í˜ì´ì§€ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.`)) return;

      try {
        const weekKey = new Date().toISOString().substring(0, 10) + "-W" + Date.now().toString().slice(-4);
        await db.collection("weekly_results").doc(weekKey).set({
          week: new Date().toISOString().substring(0, 10) + " ë¶„ë°° ê²°ì‚°",
          totalReward: totalRewardToDistribute,
          result: finalWeeklyData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ì„±ê³µì ìœ¼ë¡œ ê²°ì‚°ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = "history.html"; 
      } catch (error) {
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
      }
    }
  </script>
</body>
</html>