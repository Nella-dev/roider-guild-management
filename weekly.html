<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì£¼ê°„ ê²°ì‚°</title>
  <link rel="stylesheet" href="header_standard.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_key.js"></script>
  <script src="firebase_config.js"></script>
  <script src="i18n.js"></script>

  <style>
    body { margin:0; background:#0f1015; color:#e6e6e6; }
    .wrap { max-width:1100px; margin:40px auto; padding:20px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; text-align:center; border:1px solid #2a3242; }
    th { background:#121721; color:#f4c430; }
    .admin-only { display:none; margin-top:30px; }
  </style>
</head>

<body>

<header>
  <div class="logo" onclick="location.href='main.html'">ROIDER GUILD</div>
  <div class="user-box">
    <img id="userPhoto" />
    <span id="userName"></span>
    <span id="myRoleBadge" class="role-badge"></span>
    <button class="logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="wrap">

  <h2>ğŸ† ì£¼ê°„ ê¸¸ë“œ í™œë™ ë­í‚¹</h2>

  <table>
    <thead>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ë‹‰ë„¤ì„</th>
        <th>í•©ì‚° í‰ê· </th>
        <th>ì˜ˆìƒ ë¶„ë°°</th>
      </tr>
    </thead>
    <tbody id="resultTable">
      <tr><td colspan="4">ë¡œë”©ì¤‘...</td></tr>
    </tbody>
  </table>

  <div class="admin-only" id="adminBox">
    <h3>ğŸ›¡ï¸ ìš´ì˜ì§„ ê²°ì‚°</h3>
    <input type="number" id="totalReward" placeholder="ì´ ë¶„ë°° ìƒì ì…ë ¥">
    <button onclick="calculateWeekly(false)">ë¯¸ë¦¬ë³´ê¸°</button>
    <button onclick="finalize()">í™•ì • ì €ì¥</button>
  </div>

</div>

<script>

let isAdmin = false;
let finalWeeklyData = {};
let totalRewardToDistribute = 0;

auth.onAuthStateChanged(async (user) => {
  if (!user) return location.replace("login.html");

  const snap = await db.collection("users").doc(user.uid).get();
  if (snap.exists) {
    const role = snap.data().role;
    if (role === "admin" || role === "manager") {
      isAdmin = true;
      document.getElementById("adminBox").style.display = "block";
    }
  }

  calculateWeekly(true);
});

async function calculateWeekly(isAuto) {

  if (!isAuto) {
    totalRewardToDistribute = Number(document.getElementById("totalReward").value);
    if (totalRewardToDistribute <= 0) {
      alert("ì´ ë¶„ë°° ìƒìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
  }

  const tbody = document.getElementById("resultTable");
  tbody.innerHTML = "<tr><td colspan='4'>ê³„ì‚°ì¤‘...</td></tr>";

  const usersSnap = await db.collection("users").get();
  const logsSnap = await db.collection("attendance_logs").get();

  const nicknameMap = {};
  usersSnap.forEach(doc => {
    nicknameMap[doc.id] = doc.data().nickname;
  });

  let parsedData = [];

  for (const userDoc of logsSnap.docs) {

    let total = 0;
    let count = 0;

    const daysSnap = await userDoc.ref.collection("days").get();
    daysSnap.forEach(d => {
      const v = d.data();
      total += (v.laby || 0) + (v.duel || 0) + (v.activity || 0);
      count++;
    });

    if (total > 0) {
      parsedData.push({
        uid: userDoc.id,
        nickname: nicknameMap[userDoc.id] || "Unknown",
        avg: count > 0 ? (total / count) : 0
      });
    }
  }

  parsedData.sort((a,b)=> b.avg - a.avg);

  tbody.innerHTML = "";
  finalWeeklyData = {};

  // ğŸ”¥ ì°¨ë“± ë¶„ë°° ë¡œì§
  if (!isAuto) {

    const eligible = parsedData.slice(0,15);

    if (eligible.length < 10) {
      alert("ë¶„ë°°ëŠ” ìµœì†Œ 10ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    const weights = eligible.map((m,i)=>{
      if (i===0) return 1.6;
      if (i===1) return 1.4;
      if (i===2) return 1.2;
      return 1.0;
    });

    const totalWeight = weights.reduce((a,b)=>a+b,0);

    eligible.forEach((m,i)=>{
      const reward = Math.floor(totalRewardToDistribute * (weights[i]/totalWeight));
      finalWeeklyData[m.uid] = reward;
    });
  }

  parsedData.forEach((d,i)=>{
    const reward = finalWeeklyData[d.uid] || 0;
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${d.nickname}</td>
        <td>${d.avg.toFixed(1)}</td>
        <td>${reward}</td>
      </tr>
    `;
  });

}

async function finalize() {

  if (!isAdmin) return;

  if (Object.keys(finalWeeklyData).length === 0) {
    alert("ë¨¼ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
    return;
  }

  await db.collection("weekly_results").add({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    totalBoxes: totalRewardToDistribute,
    results: finalWeeklyData
  });

  alert("ê²°ì‚° ì €ì¥ ì™„ë£Œ!");
}

</script>

</body>
</html>