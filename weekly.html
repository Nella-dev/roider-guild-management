<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì£¼ê°„ ê²°ì‚°</title>
  <link rel="stylesheet" href="header_standard.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_key.js"></script>
  <script src="firebase_config.js"></script>
  <script src="i18n.js"></script>
  <script src="calendar_patch.js"></script>
  <style>
    body { margin: 0; background: radial-gradient(circle at top, #1b2333, #0f1015 60%); color: #e6e6e6; min-height: 100vh; }
    .wrap { max-width: 1100px; margin: 40px auto; padding: 20px; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 24px; border: 1px solid #2a3242; margin-bottom: 20px; }
    h2 { color: #f4c430; margin-top: 0; font-weight: 800; }
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 14.5px; text-align: center; }
    th { background: #121721; color: #f4c430; padding: 14px 10px; border-top: 1px solid #2a3242; border-bottom: 1px solid #2a3242; }
    td { background: #1c1f2a; padding: 14px 10px; border-top: 1px solid #2a3242; border-bottom: 1px solid #2a3242; }
    .admin-only { display: none; background: rgba(255, 82, 82, 0.05); border-color: #ff5252; margin-top: 30px; }
    .col-reward { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="" alt="profile" style="width:32px; height:32px; border-radius:50%;" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button id="langToggleBtn" class="logout" onclick="toggleLanguage()">ğŸŒ EN</button>
      <button class="logout" onclick="logout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link" data-i18n="menu_home">í™ˆ</a>
      <a href="notice.html" class="nav-link" data-i18n="menu_notice">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link" data-i18n="menu_calendar">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link active" data-i18n="menu_weekly">ì£¼ê°„ ê²°ì‚°</a>
      <a href="strategy.html" class="nav-link" data-i18n="menu_strategy">ì‘ì „ ì§€ë„</a>
      <a href="members.html" class="nav-link" data-i18n="menu_members">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none;" data-i18n="menu_admin">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>
  <div class="wrap">
    <div class="card">
      <h2 data-i18n="weekly_title">ğŸ† ì£¼ê°„ ê¸¸ë“œ í™œë™ ë­í‚¹ (ì‹¤ì‹œê°„)</h2>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="col_rank">ìˆœìœ„</th>
              <th data-i18n="col_nickname">ë‹‰ë„¤ì„</th>
              <th data-i18n="col_laby">ì´ê³„ (í‰ê· )</th>
              <th data-i18n="col_duel">ëª…ê²° (í‰ê· )</th>
              <th data-i18n="col_activity">í™œì•½ë„ (í‰ê· )</th>
              <th data-i18n="col_total">í•©ì‚° í‰ê· ì ìˆ˜</th>
              <th data-i18n="col_share">ê¸°ì—¬ ì§€ë¶„ìœ¨</th>
              <th class="col-reward" data-i18n="col_reward" style="color:#00e676;">ì˜ˆìƒ ë¶„ë°°ëŸ‰</th>
            </tr>
          </thead>
          <tbody id="resultTable">
            <tr><td colspan="8" data-i18n="msg_loading">ë¡œë”©ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card admin-only" id="adminBox">
      <h3 data-i18n="admin_title" style="color:#ff5252;">ğŸ›¡ï¸ ìš´ì˜ì§„ ê²°ì‚° ë° ë¶„ë°° ê´€ë¦¬</h3>
      <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; background:#1c1212; padding:15px; border-radius:10px; border:1px solid #ff5252;">
        <div>
          <label id="adminLabelEl" style="display:block; font-size:12px; color:#bbb; margin-bottom:5px;"></label>
          <input type="number" id="totalReward" style="padding:10px; border-radius:8px; border:1px solid #444; background:#111; color:#fff; width:160px;">
        </div>
        <button id="btnPreview" onclick="calculateWeekly(false)" style="padding:10px 20px; background:#f4c430; border:none; border-radius:8px; font-weight:800; cursor:pointer; color:#111;"></button>
      </div>
      <button id="btnConfirm" onclick="finalize()" style="width:100%; padding:15px; background:#ff5252; color:#fff; border:none; border-radius:8px; font-weight:800; cursor:pointer;"></button>
    </div>
  </div>

  <script>
    let isAdmin = false, finalWeeklyData = {}, totalRewardToDistribute = 0;

    // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ i18nìœ¼ë¡œ ì±„ìš°ëŠ” í•¨ìˆ˜
    function applyAdminButtonTexts() {
      const label = document.getElementById("adminLabelEl");
      const preview = document.getElementById("btnPreview");
      const confirm = document.getElementById("btnConfirm");
      const d = i18n[currentLang];
      if (label) label.textContent = d.admin_label || "ì´ ë¶„ë°° ê³¨ë“œ ì…ë ¥";
      if (preview) preview.textContent = d.btn_preview || "ë¯¸ë¦¬ë³´ê¸°";
      if (confirm) confirm.textContent = d.btn_confirm || "âœ… ê²°ì‚° í™•ì • (DB ì €ì¥)";
    }

    // ì–¸ì–´ ë³€ê²½ í›…
    window.onLanguageChanged = function() {
      applyAdminButtonTexts();
      calculateWeekly(true);
    };

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists && (docSnap.data().role === "admin" || docSnap.data().role === "manager")) {
        isAdmin = true;
        document.getElementById("adminBox").style.display = "block";
      }
      applyAdminButtonTexts();
      calculateWeekly(true);
    });

    async function calculateWeekly(isAuto) {
      if (!isAuto) {
        totalRewardToDistribute = Number(document.getElementById("totalReward").value);
      }
      const tbody = document.getElementById("resultTable");
      tbody.innerHTML = `<tr><td colspan="8" data-i18n="msg_loading">${i18n[currentLang].msg_loading}</td></tr>`;

      const usersSnap = await db.collection("users").get();
      const userMap = {};
      usersSnap.forEach(u => { userMap[u.id] = u.data().nickname; });

      const logsSnap = await db.collection("attendance_logs").get();
      let guildTotalAverageScore = 0;
      let parsedData = [];

      for (const userDoc of logsSnap.docs) {
        let sumLaby = 0, sumDuel = 0, sumActivity = 0, dayCount = 0;
        const daysSnap = await userDoc.ref.collection("days").get();
        daysSnap.forEach(d => {
          const v = d.data();
          sumLaby += v.laby || 0;
          sumDuel += v.duel || 0;
          sumActivity += v.activity || 0;
          dayCount++;
        });

        if (sumLaby + sumDuel + sumActivity > 0) {
          const divisor = dayCount > 0 ? dayCount : 7;
          const avgLaby = Number((sumLaby / divisor).toFixed(1));
          const avgDuel = Number((sumDuel / divisor).toFixed(1));
          const avgActivity = Number((sumActivity / divisor).toFixed(1));
          const totalAvg = avgLaby + avgDuel + avgActivity;
          guildTotalAverageScore += totalAvg;
          parsedData.push({
            uid: userDoc.id,
            nickname: userMap[userDoc.id] || "Unknown",
            avgLaby, avgDuel, avgActivity, totalAvg
          });
        }
      }

      tbody.innerHTML = "";
      parsedData.sort((a, b) => b.totalAvg - a.totalAvg).forEach((d, i) => {
        cconst shareRatio = guildTotalAverageScore > 0 
  ? (d.totalAvg / guildTotalAverageScore) 
  : 0;

let myReward = 0;

// ğŸ”¥ ë¯¸ë¦¬ë³´ê¸° ëˆŒë €ì„ ë•Œë§Œ ì°¨ë“± ê°€ì¤‘ ë¶„ë°° ì ìš©
if (!isAuto && totalRewardToDistribute > 0) {

  const eligible = parsedData.slice(0, 15); // ìƒìœ„ 15ëª…ë§Œ

  if (eligible.length < 10) {
    alert(currentLang === "en"
      ? "At least 10 members required."
      : "ë¶„ë°°ëŠ” ìµœì†Œ 10ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  const weights = eligible.map((m, idx) => {
    if (idx === 0) return 1.6;
    if (idx === 1) return 1.4;
    if (idx === 2) return 1.2;
    return 1.0;
  });

  const totalWeight = weights.reduce((a, b) => a + b, 0);

  const myIndex = eligible.findIndex(m => m.uid === d.uid);

  if (myIndex !== -1) {
    myReward = Math.floor(
      totalRewardToDistribute * (weights[myIndex] / totalWeight)
    );
  }
}

finalWeeklyData[d.uid] = { nickname: d.nickname, reward: myReward };
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${d.nickname}</td>
            <td>${d.avgLaby.toFixed(1)}</td>
            <td>${d.avgDuel.toFixed(1)}</td>
            <td>${d.avgActivity.toFixed(1)}</td>
            <td>${d.totalAvg.toFixed(1)}</td>
            <td>${(shareRatio * 100).toFixed(2)}%</td>
            <td class="col-reward">${myReward.toLocaleString()}</td>
          </tr>`;
      });

      if (parsedData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="color:#aaa;">${i18n[currentLang].adm_empty || "ë°ì´í„° ì—†ìŒ"}</td></tr>`;
      }

      if (!isAuto) {
        document.querySelectorAll('.col-reward').forEach(el => el.style.display = 'table-cell');
      }
      applyLanguage();
    }

    async function finalize() {
      if (!isAdmin || totalRewardToDistribute <= 0) return;
      const msg = currentLang === "en" ? "Settlement confirmed!" : "ê²°ì‚° í™•ì •!";
      try {
        await db.collection("weekly_results").add({
          totalReward: totalRewardToDistribute,
          result: finalWeeklyData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert(msg);
      } catch (e) {
        alert("Error: " + e.message);
      }
    }
  </script>
</body>
</html>
