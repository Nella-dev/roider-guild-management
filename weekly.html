<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì£¼ê°„ ë­í‚¹ ë° ê²°ì‚°</title>

  <link rel="stylesheet" href="header_standard.css">
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { 
      margin: 0; 
      background: radial-gradient(circle at top, #1b2333, #0f1015 60%); 
      color: #e6e6e6; 
      min-height: 100vh; 
    }
    
    .wrap { max-width: 1100px; margin: 40px auto; padding: 20px; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 24px; border: 1px solid #2a3242; margin-bottom: 20px; }
    
    h2 { color: #f4c430; margin-top: 0; font-weight: 800; }
    .desc { color: #aaa; margin-bottom: 24px; font-weight: 500; }
    
    /* ğŸ’¡ ê²°ì‚° í…Œì´ë¸” ë° ë­í‚¹ íŠ¹ìˆ˜ íš¨ê³¼ ìŠ¤íƒ€ì¼ */
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 14.5px; text-align: center; }
    th { background: #121721; color: #f4c430; font-weight: 700; font-size: 14px; padding: 14px 10px; border-top: 1px solid #2a3242; border-bottom: 1px solid #2a3242; }
    td { background: #1c1f2a; padding: 14px 10px; border-top: 1px solid #2a3242; border-bottom: 1px solid #2a3242; transition: all 0.3s; }
    td:first-child { border-left: 1px solid #2a3242; border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
    td:last-child { border-right: 1px solid #2a3242; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
    
    .highlight { color: #00e676; font-weight: 800; font-size: 16px; }
    .total-row td { background: rgba(244, 196, 48, 0.08); font-weight: 800; color: #f4c430; border-color: #f4c430; }

    /* ğŸ‘‘ 1ìœ„ íš¨ê³¼ (Gold) */
    .rank-1 td { background: rgba(255, 215, 0, 0.15); border-color: #ffd700; color: #fff; font-weight: 800; box-shadow: 0px 4px 15px rgba(255, 215, 0, 0.2); }
    .rank-1 .rank-icon { font-size: 22px; text-shadow: 0 0 10px #ffd700; }
    .rank-1 .score-text { color: #ffd700; font-size: 18px; }

    /* ğŸ¥ˆ 2ìœ„ íš¨ê³¼ (Silver) */
    .rank-2 td { background: rgba(192, 192, 192, 0.1); border-color: #c0c0c0; color: #fff; font-weight: 700; }
    .rank-2 .rank-icon { font-size: 20px; text-shadow: 0 0 8px #c0c0c0; }
    .rank-2 .score-text { color: #e0e0e0; font-size: 17px; }

    /* ğŸ¥‰ 3ìœ„ íš¨ê³¼ (Bronze) */
    .rank-3 td { background: rgba(205, 127, 50, 0.1); border-color: #cd7f32; color: #fff; font-weight: 700; }
    .rank-3 .rank-icon { font-size: 18px; text-shadow: 0 0 8px #cd7f32; }
    .rank-3 .score-text { color: #cd7f32; font-size: 16px; }

    /* ì¼ë°˜ ìˆœìœ„ */
    .rank-normal .rank-icon { font-size: 15px; color: #888; font-weight: 800; }
    .rank-normal .score-text { color: #f4c430; font-weight: 800; }

    /* ìš´ì˜ì§„ ì „ìš© ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .admin-only { display: none; background: #2a1515; border-color: #ff5252; margin-top: 30px; }
    .admin-only h3 { color: #ff5252; margin-top: 0; font-weight: 800; margin-bottom: 10px; }
    .control-panel { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end; background: #1c1212; padding: 18px; border-radius: 10px; border: 1px solid #ff5252; }
    .control-panel label { display: block; font-size: 13px; margin-bottom: 6px; color: #bbb; font-weight: 600; }
    .control-panel input[type="number"] { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; width: 160px; font-size: 15px; font-weight: 600; font-family: inherit; }
    
    .btn-calc { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; background: #f4c430; color: #111; font-family: inherit; font-size: 15px; }
    .btn-calc:hover { background: #d4a924; }
    .btn-save { background: #ff5252; color: #fff; padding: 14px 20px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 15px; font-family: inherit; width: 100%; margin-top: 10px; }
    .btn-save:hover { background: #e04848; }

    /* ìš´ì˜ì§„ ì „ìš© ë¶„ë°°ëŸ‰ ì»¬ëŸ¼ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .col-reward { display: none; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>
  
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link">í™ˆ</a>
      <a href="notice.html" class="nav-link">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link">ì£¼ê°„ ê²°ì‚°</a>
      <a href="members.html" class="nav-link">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none; color: #ff5252;">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>
  <div class="wrap">
    
    <div class="card">
      <h2>ğŸ† ì£¼ê°„ ê¸¸ë“œ í™œë™ ë­í‚¹ (ì‹¤ì‹œê°„)</h2>
      <p class="desc">ì¼ì£¼ì¼ í‰ê·  ì ìˆ˜ í•©ì‚°ì„ ê¸°ì¤€ìœ¼ë¡œ ìˆœìœ„ê°€ ë§¤ê²¨ì§‘ë‹ˆë‹¤. ìƒìœ„ê¶Œì— ë„ì „í•˜ì„¸ìš”!</p>
      
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ìˆœìœ„</th>
              <th>ë‹‰ë„¤ì„</th>
              <th>ì´ê³„ (í‰ê· )</th>
              <th>ëª…ê²° (í‰ê· )</th>
              <th>í™œì•½ë„ (í‰ê· )</th>
              <th>í•©ì‚° í‰ê· ì ìˆ˜</th>
              <th>ê¸°ì—¬ ì§€ë¶„ìœ¨</th>
              <th class="col-reward" style="color:#00e676;">ì˜ˆìƒ ë¶„ë°°ëŸ‰</th>
            </tr>
          </thead>
          <tbody id="resultTable">
            <tr><td colspan="8" style="padding:40px; color:#aaa; font-weight: 500;">ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card admin-only" id="adminBox">
      <h3>ğŸ›¡ï¸ ìš´ì˜ì§„ ê²°ì‚° ë° ë¶„ë°° ê´€ë¦¬</h3>
      <p style="color:#aaa; font-weight: 500; margin-bottom: 20px;">ìƒì ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì—¬ ë¶„ë°°ëŸ‰ì„ ë¯¸ë¦¬ë³´ê¸° í•œ ë’¤, ì´ë²ˆ ì£¼ ê³µì‹ ê¸°ë¡ìœ¼ë¡œ í™•ì •í•˜ì„¸ìš”.</p>
      
      <div class="control-panel">
        <div>
          <label>ğŸ“¦ ë¶„ë°°í•  ì´ ìƒì ê°œìˆ˜</label>
          <input type="number" id="totalReward" placeholder="ì˜ˆ: 10000" min="0">
        </div>
        <button class="btn-calc" onclick="calculateWeekly(false)">ë¶„ë°° ê³„ì‚° ë¯¸ë¦¬ë³´ê¸°</button>
      </div>

      <button class="btn-save" onclick="finalize()">ì´ëŒ€ë¡œ ê²°ì‚° í™•ì • ë° ì´ë ¥ ì €ì¥</button>
    </div>
  </div>

  <script>
    let isAdmin = false;
    let finalWeeklyData = {};
    let totalRewardToDistribute = 0;

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const data = docSnap.data();
        if (data.role === "admin" || data.role === "manager") {
          isAdmin = true;
          document.getElementById("adminBox").style.display = "block";
        }
      }
      // ì ‘ì† ì‹œ ë¬´ì¡°ê±´ ë­í‚¹ë¶€í„° ìë™ìœ¼ë¡œ ë Œë”ë§
      calculateWeekly(true);
    });

    async function calculateWeekly(isAutoLoad = false) {
      if (!isAutoLoad) {
        const rewardInput = document.getElementById("totalReward").value;
        if (!rewardInput) return alert("ë¶„ë°°í•  ì´ ìƒì ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        totalRewardToDistribute = Number(rewardInput);
        
        // ìš´ì˜ì§„ì´ ê³„ì‚° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¶„ë°°ëŸ‰ ì—´(Column) ë³´ì´ê¸°
        document.querySelectorAll('.col-reward').forEach(el => el.style.display = 'table-cell');
      } else {
        totalRewardToDistribute = 0; 
      }

      const tbody = document.getElementById("resultTable");
      if (!isAutoLoad) tbody.innerHTML = "<tr><td colspan='8' style='padding:20px;'>ë¶„ë°°ëŸ‰ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
      finalWeeklyData = {};

      const usersSnap = await db.collection("users").get();
      const userMap = {};
      usersSnap.forEach(u => userMap[u.id] = u.data().nickname);

      const logsSnap = await db.collection("attendance_logs").get();
      
      let guildTotalAverageScore = 0; 
      const parsedData = [];

      for (const userDoc of logsSnap.docs) {
        const uid = userDoc.id;
        let sumLaby = 0, sumDuel = 0, sumActivity = 0;

        const daysSnap = await userDoc.ref.collection("days").get();
        daysSnap.forEach(d => {
          const v = d.data();
          sumLaby += (v.laby || 0);
          sumDuel += (v.duel || 0);
          sumActivity += (v.activity || 0);
        });

        if (sumLaby > 0 || sumDuel > 0 || sumActivity > 0) {
          const avgLaby = (sumLaby / 7).toFixed(1);
          const avgDuel = (sumDuel / 7).toFixed(1);
          const avgActivity = (sumActivity / 7).toFixed(1);
          
          const totalAvgScore = Number(avgLaby) + Number(avgDuel) + Number(avgActivity);
          guildTotalAverageScore += totalAvgScore;

          parsedData.push({
            uid: uid,
            nickname: userMap[uid] || "ì•Œìˆ˜ì—†ìŒ",
            avgLaby: Number(avgLaby),
            avgDuel: Number(avgDuel),
            avgActivity: Number(avgActivity),
            totalAvg: totalAvgScore
          });
        }
      }

      tbody.innerHTML = "";
      if (parsedData.length === 0) {
        tbody.innerHTML = "<tr><td colspan='8' style='padding:40px; color:#aaa;'>ì´ë²ˆ ì£¼ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
      }

      // ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (ë­í‚¹)
      parsedData.sort((a, b) => b.totalAvg - a.totalAvg);

      parsedData.forEach((d, index) => {
        const rank = index + 1; // ìˆœìœ„ ê³„ì‚°
        
        // ğŸ’¡ 1, 2, 3ìœ„ì—ê²Œ íŠ¹ìˆ˜ í´ë˜ìŠ¤ ë° ì•„ì´ì½˜ ë¶€ì—¬
        let rankClass = "rank-normal";
        let rankIcon = `${rank}ìœ„`;
        if (rank === 1) { rankClass = "rank-1"; rankIcon = "ğŸ¥‡ 1ìœ„"; }
        else if (rank === 2) { rankClass = "rank-2"; rankIcon = "ğŸ¥ˆ 2ìœ„"; }
        else if (rank === 3) { rankClass = "rank-3"; rankIcon = "ğŸ¥‰ 3ìœ„"; }

        const shareRatio = guildTotalAverageScore > 0 ? (d.totalAvg / guildTotalAverageScore) : 0;
        const sharePercent = (shareRatio * 100).toFixed(2);
        
        const myReward = Math.floor(totalRewardToDistribute * shareRatio);
        
        // ë°ì´í„° ì €ì¥
        finalWeeklyData[d.uid] = { nickname: d.nickname, sharePercent: sharePercent, reward: myReward };

        tbody.innerHTML += `
          <tr class="${rankClass}">
            <td><span class="rank-icon">${rankIcon}</span></td>
            <td><b>${d.nickname}</b></td>
            <td>${d.avgLaby}</td>
            <td>${d.avgDuel}</td>
            <td>${d.avgActivity}</td>
            <td><span class="score-text">${d.totalAvg.toFixed(1)}</span></td>
            <td>${sharePercent}%</td>
            <td class="col-reward highlight">${totalRewardToDistribute > 0 ? myReward.toLocaleString() : "-"}</td>
          </tr>
        `;
      });

      const totalRewardText = totalRewardToDistribute > 0 ? totalRewardToDistribute.toLocaleString() : "-";
      
      tbody.innerHTML += `
        <tr class="total-row">
          <td colspan="5">ê¸¸ë“œ ì´ í•©ì‚° ì ìˆ˜</td>
          <td>${guildTotalAverageScore.toFixed(1)}</td>
          <td>100.00%</td>
          <td class="col-reward">${totalRewardText}</td>
        </tr>
      `;
      
      // ë§Œì•½ ì´ë¯¸ ìˆ˜ë™ ê³„ì‚° ëª¨ë“œë¼ë©´ ë¶„ë°°ëŸ‰ ì—´ ë³´ì´ê²Œ ìœ ì§€
      if (!isAutoLoad) {
        document.querySelectorAll('.col-reward').forEach(el => el.style.display = 'table-cell');
      }
    }

    async function finalize() {
      if (!isAdmin) return;
      if (totalRewardToDistribute <= 0) return alert("ë¨¼ì € ì´ ìƒì ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ê³  'ë¶„ë°° ê³„ì‚° ë¯¸ë¦¬ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      
      if (!confirm(`ì´ ìƒì ${totalRewardToDistribute}ê°œë¡œ ê²°ì‚°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ ì´ë ¥ í˜ì´ì§€ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.`)) return;

      try {
        const weekKey = new Date().toISOString().substring(0, 10) + "-W" + Date.now().toString().slice(-4);
        await db.collection("weekly_results").doc(weekKey).set({
          week: new Date().toISOString().substring(0, 10) + " ë¶„ë°° ê²°ì‚°",
          totalReward: totalRewardToDistribute,
          result: finalWeeklyData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ì„±ê³µì ìœ¼ë¡œ ê²°ì‚°ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = "history.html"; 
      } catch (error) {
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
      }
    }
  </script>
</body>
</html>