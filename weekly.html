<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì£¼ê°„ ê²°ì‚°</title>

  <link rel="stylesheet" href="header_standard.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 20px; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 20px; border: 1px solid #2a3242; margin-bottom: 20px; }
    h2 { color: #f4c430; margin-top: 0; }
    button { padding: 10px 14px; border-radius: 8px; border: none; background: #00e676; color: #000; font-weight: bold; cursor: pointer; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #2a3242; padding: 12px; text-align: center; }
    th { background: #121721; color: #f4c430; }
    .admin-only { display: none; background: #2a1515; border-color: #ff5252; }
    .admin-only h3 { color: #ff5252; }
    input[type="number"] { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #111; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>ğŸ’° ì´ë²ˆ ì£¼ í™œë™ í˜„í™©</h2>
      <button onclick="calculateWeekly()">í˜„í™© ì§‘ê³„í•˜ê¸°</button>
      
      <table>
        <thead>
          <tr>
            <th>ë‹‰ë„¤ì„</th>
            <th>ì´ê³„ ì´í•©</th>
            <th>ëª…ê²° ì´í•©</th>
          </tr>
        </thead>
        <tbody id="resultTable">
          <tr><td colspan="3">ì§‘ê³„í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card admin-only" id="adminBox">
      <h3>ğŸ› ï¸ ê´€ë¦¬ì ê²°ì‚° í™•ì •</h3>
      <p>ì´ë²ˆ ì£¼ ì´ ìƒì ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ê³  ë¶„ë°° ê²°ê³¼ë¥¼ í™•ì •í•˜ì„¸ìš”.</p>
      ì´ ìƒì: <input type="number" id="totalChest" placeholder="ê°œìˆ˜ ì…ë ¥">
      <button style="background:#ff5252; color:#fff;" onclick="finalize()">ê²°ê³¼ í™•ì • ë° ì €ì¥</button>
    </div>
  </div>

  <script>
    let isAdmin = false;
    let weeklyData = {};

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("userName").textContent = data.nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;

        // ê´€ë¦¬ìì¸ì§€ í™•ì¸í•˜ì—¬ ê´€ë¦¬ì í¼ ë…¸ì¶œ
        if (data.role === "admin") {
          isAdmin = true;
          document.getElementById("adminBox").style.display = "block";
        }
      }
    });

    // 1. ì£¼ê°„ ë°ì´í„° ì§‘ê³„ ë¡œì§
    async function calculateWeekly() {
      const tbody = document.getElementById("resultTable");
      tbody.innerHTML = "<tr><td colspan='3'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
      weeklyData = {};

      // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë‹‰ë„¤ì„ ë§¤í•‘ìš©)
      const usersSnap = await db.collection("users").get();
      const userMap = {};
      usersSnap.forEach(u => userMap[u.id] = u.data().nickname);

      // ì¶œì„ ê¸°ë¡ ì „ì²´ íƒìƒ‰ (ì‹¤ë¬´ì—ì„œëŠ” ë‚ ì§œ í•„í„°ë§ ê¶Œì¥)
      const logsSnap = await db.collection("attendance_logs").get();
      
      for (const userDoc of logsSnap.docs) {
        const uid = userDoc.id;
        let totalLaby = 0;
        let totalDuel = 0;

        const daysSnap = await userDoc.ref.collection("days").get();
        daysSnap.forEach(d => {
          totalLaby += d.data().laby || 0;
          totalDuel += d.data().duel || 0;
        });

        if (totalLaby > 0 || totalDuel > 0) {
          weeklyData[uid] = { nickname: userMap[uid] || "ì•Œìˆ˜ì—†ìŒ", laby: totalLaby, duel: totalDuel };
        }
      }

      // í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = "";
      for (const uid in weeklyData) {
        const d = weeklyData[uid];
        tbody.innerHTML += `
          <tr>
            <td>${d.nickname}</td>
            <td>${d.laby}</td>
            <td>${d.duel}</td>
          </tr>
        `;
      }
      if (Object.keys(weeklyData).length === 0) {
        tbody.innerHTML = "<tr><td colspan='3'>ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
      }
    }

    // 2. ê´€ë¦¬ì ê²°ì‚° í™•ì • ë¡œì§
    async function finalize() {
      if (!isAdmin) return alert("ê´€ë¦¬ìë§Œ í™•ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const chest = document.getElementById("totalChest").value;
      if (!chest) return alert("ì´ ìƒì ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      if (!confirm(`ì´ ${chest}ê°œì˜ ìƒìë¡œ ê²°ì‚°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        // historyìš© ì»¬ë ‰ì…˜ì— ì €ì¥ (YYYY-MM-DD-time í˜•ì‹ í‚¤ ìƒì„±)
        const weekKey = new Date().toISOString().substring(0, 10) + "-" + Date.now();
        await db.collection("weekly_results").doc(weekKey).set({
          week: new Date().toISOString().substring(0, 10) + " ì£¼ê°„ ê²°ì‚°",
          totalChests: Number(chest),
          result: weeklyData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ê²°ì‚°ì´ ì„±ê³µì ìœ¼ë¡œ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = "history.html"; // ì£¼ê°„ ë¶„ë°° ì´ë ¥ í˜ì´ì§€ë¡œ ì´ë™
      } catch (error) {
        alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
      }
    }
  </script>
</body>
</html>