<script>
let isAdmin = false;
let finalWeeklyData = {};
let totalRewardToDistribute = 0;

// Î≤ÑÌäº ÌÖçÏä§Ìä∏ i18n Ïú†ÏßÄ
function applyAdminButtonTexts() {
  const label = document.getElementById("adminLabelEl");
  const preview = document.getElementById("btnPreview");
  const confirm = document.getElementById("btnConfirm");
  const d = i18n[currentLang];
  if (label) label.textContent = d.admin_label || "Ï¥ù Î∂ÑÎ∞∞ ÏÉÅÏûê ÏûÖÎ†•";
  if (preview) preview.textContent = d.btn_preview || "ÎØ∏Î¶¨Î≥¥Í∏∞";
  if (confirm) confirm.textContent = d.btn_confirm || "‚úÖ Í≤∞ÏÇ∞ ÌôïÏ†ï (DB Ï†ÄÏû•)";
}

window.onLanguageChanged = function() {
  applyAdminButtonTexts();
  calculateWeekly(true);
};

auth.onAuthStateChanged(async (user) => {
  if (!user) return location.replace("login.html");

  const docSnap = await db.collection("users").doc(user.uid).get();
  if (docSnap.exists && 
     (docSnap.data().role === "admin" || docSnap.data().role === "manager")) {
    isAdmin = true;
    document.getElementById("adminBox").style.display = "block";
  }

  applyAdminButtonTexts();
  calculateWeekly(true);
});

async function calculateWeekly(isAuto) {

  if (!isAuto) {
    totalRewardToDistribute = Number(document.getElementById("totalReward").value);
    if (totalRewardToDistribute <= 0) {
      alert("Ï¥ù Î∂ÑÎ∞∞ ÏÉÅÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
      return;
    }
  }

  const tbody = document.getElementById("resultTable");
  tbody.innerHTML = `<tr><td colspan="8">${i18n[currentLang].msg_loading}</td></tr>`;

  const usersSnap = await db.collection("users").get();
  const userMap = {};
  usersSnap.forEach(u => { userMap[u.id] = u.data().nickname; });

  const logsSnap = await db.collection("attendance_logs").get();

  let guildTotalAverageScore = 0;
  let parsedData = [];

  for (const userDoc of logsSnap.docs) {

    let sumLaby = 0, sumDuel = 0, sumActivity = 0, dayCount = 0;
    const daysSnap = await userDoc.ref.collection("days").get();

    daysSnap.forEach(d => {
      const v = d.data();
      sumLaby += v.laby || 0;
      sumDuel += v.duel || 0;
      sumActivity += v.activity || 0;
      dayCount++;
    });

    if (sumLaby + sumDuel + sumActivity > 0) {

      const divisor = dayCount > 0 ? dayCount : 7;
      const avgLaby = Number((sumLaby / divisor).toFixed(1));
      const avgDuel = Number((sumDuel / divisor).toFixed(1));
      const avgActivity = Number((sumActivity / divisor).toFixed(1));
      const totalAvg = avgLaby + avgDuel + avgActivity;

      guildTotalAverageScore += totalAvg;

      parsedData.push({
        uid: userDoc.id,
        nickname: userMap[userDoc.id] || "Unknown",
        avgLaby, avgDuel, avgActivity, totalAvg
      });
    }
  }

  parsedData.sort((a, b) => b.totalAvg - a.totalAvg);

  tbody.innerHTML = "";
  finalWeeklyData = {};

  // üî• ======= Ï∞®Îì± Í∞ÄÏ§ëÏπò Î∂ÑÎ∞∞ Î°úÏßÅ =======
  if (!isAuto) {

    const eligible = parsedData.slice(0, 15);

    if (eligible.length < 10) {
      alert(currentLang === "en"
        ? "At least 10 members required for distribution."
        : "Î∂ÑÎ∞∞Îäî ÏµúÏÜå 10Î™Ö Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§.");
      return;
    }

    const weights = eligible.map((m, i) => {
      if (i === 0) return 1.6;
      if (i === 1) return 1.4;
      if (i === 2) return 1.2;
      return 1.0;
    });

    const totalWeight = weights.reduce((a, b) => a + b, 0);

    eligible.forEach((m, i) => {
      const reward = Math.floor(
        totalRewardToDistribute * (weights[i] / totalWeight)
      );
      finalWeeklyData[m.uid] = reward;
    });
  }
  // =======================================

  parsedData.forEach((d, i) => {

    const shareRatio = guildTotalAverageScore > 0
      ? (d.totalAvg / guildTotalAverageScore)
      : 0;

    const reward = finalWeeklyData[d.uid] || 0;

    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${d.nickname}</td>
        <td>${d.avgLaby.toFixed(1)}</td>
        <td>${d.avgDuel.toFixed(1)}</td>
        <td>${d.avgActivity.toFixed(1)}</td>
        <td>${d.totalAvg.toFixed(1)}</td>
        <td>${(shareRatio * 100).toFixed(2)}%</td>
        <td class="col-reward">${reward.toLocaleString()}</td>
      </tr>`;
  });

  if (parsedData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8">${i18n[currentLang].adm_empty || "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"}</td></tr>`;
  }

  if (!isAuto) {
    document.querySelectorAll('.col-reward')
      .forEach(el => el.style.display = 'table-cell');
  }

  applyLanguage();
}

async function finalize() {

  if (!isAdmin || totalRewardToDistribute <= 0) return;

  if (Object.keys(finalWeeklyData).length < 10) {
    alert("Î®ºÏ†Ä ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî.");
    return;
  }

  try {
    await db.collection("weekly_results").add({
      totalBoxes: totalRewardToDistribute,
      result: finalWeeklyData,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert(currentLang === "en"
      ? "Settlement confirmed!"
      : "Í≤∞ÏÇ∞ ÌôïÏ†ï!");

  } catch (e) {
    alert("Error: " + e.message);
  }
}
</script>