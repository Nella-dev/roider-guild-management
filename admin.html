<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ê¶Œí•œ ê´€ë¦¬</title>
  <link rel="stylesheet" href="header_standard.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; background: radial-gradient(circle at top, #1b2333, #0f1015 60%); color: #e6e6e6; min-height: 100vh; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    h2 { color: #f4c430; margin-top: 0; font-weight: 800; }
    .desc { color: #aaa; margin-bottom: 30px; line-height: 1.6; font-weight: 500; font-size: 15px;}
    .filter-group { margin-bottom: 25px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-btn { padding: 10px 18px; border: 1px solid #444; background: #1c1f2a; color: #ccc; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: 700; font-family: inherit;}
    .filter-btn.active, .filter-btn:hover { background: #f4c430; color: #111; border-color: #f4c430; }
    
    .user-card { background: #1c1f2a; border: 1px solid #2a3242; border-radius: 12px; padding: 18px 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .user-info { display: flex; flex-direction: column; gap: 6px; }
    .user-name { font-size: 18px; font-weight: 800; color: #fff; }
    .user-email { font-size: 13.5px; color: #aaa; font-weight: 500; }
    .action-group { display: flex; gap: 8px; }
    .btn-action { padding: 8px 14px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 13.5px; font-family: inherit; }
    .btn-approve { background: #00e676; color: #000; }
    .btn-manager { background: #00b0ff; color: #fff; }
    .btn-admin { background: #ff5252; color: #fff; }
    .btn-demote { background: #444; color: #fff; }
    .btn-action:hover { opacity: 0.8; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button id="langToggleBtn" class="logout" onclick="toggleLanguage()" style="color:#f4c430; border-color:#f4c430;">ğŸŒ EN</button>
      <button class="logout" onclick="logout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link" data-i18n="menu_home">í™ˆ</a>
      <a href="notice.html" class="nav-link" data-i18n="menu_notice">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link" data-i18n="menu_calendar">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link" data-i18n="menu_weekly">ì£¼ê°„ ê²°ì‚°</a>
      <a href="members.html" class="nav-link" data-i18n="menu_members">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none; color: #ff5252;" data-i18n="menu_admin">ê¶Œí•œ ê´€ë¦¬</a>
      <a href="strategy.html" class="nav-link" data-i18n="menu_strategy">ì‘ì „ ì§€ë„</a>
    </div>
  </nav>

  <div class="wrap">
    <h2 data-i18n="adm_page_title">ğŸ› ï¸ ì¸ì› ìŠ¹ì¸ ë° ê¶Œí•œ ê´€ë¦¬</h2>
    <p class="desc" data-i18n="adm_page_desc">
      <b>ë‚´ ê¶Œí•œì— ë”°ë¼ ê°€ëŠ¥í•œ ì‘ì—…ì´ ë‹¤ë¦…ë‹ˆë‹¤.</b><br>
      - ğŸ‘‘ ê´€ë¦¬ì: ëª¨ë“  ì§ì±… ì„ëª… ë° ê°•ë“± ê°€ëŠ¥<br>
      - ğŸ›¡ï¸ ìš´ì˜ì§„: ìŠ¹ì¸ ëŒ€ê¸°ì ê¸¸ë“œì› ìŠ¹ì¸ ë° ê¸¸ë“œì› ê°•ë“±ë§Œ ê°€ëŠ¥
    </p>

    <div class="filter-group">
      <button class="filter-btn active" onclick="filterUsers('all', this)" data-i18n="adm_filter_all">ì „ì²´ ë³´ê¸°</button>
      <button class="filter-btn" onclick="filterUsers('pending', this)" data-i18n="adm_filter_pending">â³ ìŠ¹ì¸ ëŒ€ê¸°</button>
      <button class="filter-btn" onclick="filterUsers('member', this)" data-i18n="adm_filter_member">âš”ï¸ ì¼ë°˜ ë©¤ë²„</button>
      <button class="filter-btn" onclick="filterUsers('manager', this)" data-i18n="adm_filter_manager">ğŸ›¡ï¸ ìš´ì˜ì§„</button>
      <button class="filter-btn" onclick="filterUsers('admin', this)" data-i18n="adm_filter_admin">ğŸ‘‘ ê´€ë¦¬ì</button>
    </div>

    <div id="userList">
      <p style="color:#aaa;" data-i18n="msg_loading">ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>

  <script>
    let allUsers = [];
    let currentFilter = 'all';
    let myRole = '';

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        myRole = docSnap.data().role;
        if (myRole !== "admin" && myRole !== "manager") {
          location.replace("main.html");
          return;
        }
        loadUsersRealtime();
      }
    });

    function loadUsersRealtime() {
      db.collection("users").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
        allUsers = [];
        snapshot.forEach((doc) => { allUsers.push({ id: doc.id, ...doc.data() }); });
        renderUsers();
      });
    }

    function filterUsers(role, btnElement) {
      currentFilter = role;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      btnElement.classList.add('active');
      renderUsers();
    }

    function renderUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";

      const filteredUsers = currentFilter === 'all' ? allUsers : allUsers.filter(u => u.role === currentFilter);

      if (filteredUsers.length === 0) {
        const textEmpty = i18n[currentLang]?.adm_empty || "ì¡°ê±´ì— ë§ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
        list.innerHTML = `<p style='color:#aaa;'>${textEmpty}</p>`;
        return;
      }

      filteredUsers.forEach(u => {
        const roleName = i18n[currentLang]?.[`role_${u.role}`] || u.role;
        const roleClass = `role-${u.role}`;
        let actionButtons = '';

        // ğŸ’¡ undefined ë°©ì§€ ì¥ì¹˜ ì¶”ê°€
        const tApprove = i18n[currentLang]?.adm_btn_approve || "ë©¤ë²„ ìŠ¹ì¸";
        const tDemoteP = i18n[currentLang]?.adm_btn_demote_pending || "ëŒ€ê¸° ê°•ë“±";
        const tManager = i18n[currentLang]?.adm_btn_manager || "ìš´ì˜ì§„ ì„ëª…";
        const tAdmin = i18n[currentLang]?.adm_btn_admin || "ê´€ë¦¬ì ì„ëª…";
        const tDemoteM = i18n[currentLang]?.adm_btn_demote_member || "ë©¤ë²„ ê°•ë“±";
        const tDemoteMg = i18n[currentLang]?.adm_btn_demote_manager || "ìš´ì˜ì§„ ê°•ë“±";

        if (u.role === 'pending') {
          actionButtons = `<button class="btn-action btn-approve" onclick="changeRole('${u.id}', 'member')">${tApprove}</button>`;
        } 
        else if (u.role === 'member') {
          actionButtons += `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'pending')">${tDemoteP}</button> `;
          if (myRole === 'admin') {
            actionButtons += `<button class="btn-action btn-manager" onclick="changeRole('${u.id}', 'manager')">${tManager}</button> `;
            actionButtons += `<button class="btn-action btn-admin" onclick="changeRole('${u.id}', 'admin')">${tAdmin}</button>`;
          }
        } 
        else if (u.role === 'manager' && myRole === 'admin') {
          actionButtons = `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'member')">${tDemoteM}</button>`;
        } 
        else if (u.role === 'admin' && myRole === 'admin') {
          actionButtons = `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'manager')">${tDemoteMg}</button>`;
        }

        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <div class="user-info">
            <span class="user-name">${u.nickname || 'Unknown'} <span class="role-badge ${roleClass}">${roleName}</span></span>
            <span class="user-email">${u.email}</span>
          </div>
          <div class="action-group">${actionButtons}</div>
        `;
        list.appendChild(div);
      });
      applyLanguage();
    }

    async function changeRole(uid, newRole) {
      if (myRole === 'manager' && (newRole === 'admin' || newRole === 'manager')) return;
      if (!confirm(`ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Change role to [${newRole}]?)`)) return;

      try { await db.collection("users").doc(uid).update({ role: newRole }); } 
      catch (error) { alert("Error: " + error.message); }
    }
  </script>
</body>
</html>