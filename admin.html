<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì¸ì› ë° ê¶Œí•œ ê´€ë¦¬</title>

  <link rel="stylesheet" href="header_standard.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    
    h2 { color: #f4c430; margin-top: 0; }
    .desc { color: #aaa; margin-bottom: 30px; line-height: 1.5; }
    
    /* í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .filter-group { margin-bottom: 25px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-btn { 
      padding: 10px 18px; border: 1px solid #444; background: #1c1f2a; 
      color: #ccc; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 14px;
    }
    .filter-btn.active, .filter-btn:hover { 
      background: #f4c430; color: #111; border-color: #f4c430; font-weight: bold; 
    }
    
    /* ìœ ì € ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .user-card { 
      background: #1c1f2a; border: 1px solid #2a3242; border-radius: 12px; 
      padding: 18px 20px; margin-bottom: 12px; display: flex; 
      justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .user-info { display: flex; flex-direction: column; gap: 6px; }
    .user-name { font-size: 18px; font-weight: bold; color: #fff; }
    .user-email { font-size: 13px; color: #aaa; }
    
    /* ê¶Œí•œ ë±ƒì§€ */
    .role-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-left: 8px; vertical-align: middle; }
    .role-pending { background: #555; color: #fff; }
    .role-member { background: #00e676; color: #000; }
    .role-manager { background: #00b0ff; color: #fff; } /* ìš´ì˜ì§„ íŒŒë€ìƒ‰ */
    .role-admin { background: #ff5252; color: #fff; }

    /* ì•¡ì…˜ ë²„íŠ¼ */
    .action-group { display: flex; gap: 8px; }
    .btn-action { padding: 8px 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; }
    .btn-approve { background: #00e676; color: #000; }
    .btn-manager { background: #00b0ff; color: #fff; }
    .btn-admin { background: #ff5252; color: #fff; }
    .btn-demote { background: #444; color: #fff; }
    .btn-action:hover { opacity: 0.8; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>
  
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link">í™ˆ</a>
      <a href="notice.html" class="nav-link">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link">ì£¼ê°„ ê²°ì‚°</a>
      <a href="members.html" class="nav-link">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none; color: #ff5252;">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>

  <div class="wrap">
    <h2>ğŸ› ï¸ ì¸ì› ìŠ¹ì¸ ë° ê¶Œí•œ ê´€ë¦¬</h2>
    <p class="desc">
      <b>ë‚´ ê¶Œí•œì— ë”°ë¼ ê°€ëŠ¥í•œ ì‘ì—…ì´ ë‹¤ë¦…ë‹ˆë‹¤.</b><br>
      - ğŸ‘‘ ê´€ë¦¬ì: ëª¨ë“  ì§ì±… ì„ëª… ë° ê°•ë“± ê°€ëŠ¥<br>
      - ğŸ›¡ï¸ ìš´ì˜ì§„: ìŠ¹ì¸ ëŒ€ê¸°ì ê¸¸ë“œì› ìŠ¹ì¸ ë° ê¸¸ë“œì› ê°•ë“±ë§Œ ê°€ëŠ¥
    </p>

    <div class="filter-group">
      <button class="filter-btn active" onclick="filterUsers('all', this)">ì „ì²´ ë³´ê¸°</button>
      <button class="filter-btn" onclick="filterUsers('pending', this)">â³ ìŠ¹ì¸ ëŒ€ê¸°</button>
      <button class="filter-btn" onclick="filterUsers('member', this)">âš”ï¸ ì¼ë°˜ ë©¤ë²„</button>
      <button class="filter-btn" onclick="filterUsers('manager', this)">ğŸ›¡ï¸ ìš´ì˜ì§„</button>
      <button class="filter-btn" onclick="filterUsers('admin', this)">ğŸ‘‘ ê´€ë¦¬ì</button>
    </div>

    <div id="userList">
      <p style="color:#aaa;">ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>

  <script>
    let allUsers = [];
    let currentFilter = 'all';
    let myRole = ''; // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ê¶Œí•œ ì €ì¥

    // 1. ì¸ì¦ ë° ê¶Œí•œ í™•ì¸
    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("userName").textContent = data.nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;

        myRole = data.role;

        // ğŸ”¥ ê´€ë¦¬ì(admin)ë‚˜ ìš´ì˜ì§„(manager)ì´ ì•„ë‹ˆë©´ ì«“ì•„ëƒ„
        if (myRole !== "admin" && myRole !== "manager") {
          alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë‚˜ ìš´ì˜ì§„ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          location.replace("main.html");
          return;
        }

        // í—¤ë”ì— ë‚´ ê¶Œí•œ ë±ƒì§€ ë‹¬ì•„ì£¼ê¸°
        const badgeEl = document.getElementById("myRoleBadge");
        if(myRole === 'admin') { badgeEl.textContent = 'ìµœê³  ê´€ë¦¬ì'; badgeEl.className = 'role-badge role-admin'; }
        if(myRole === 'manager') { badgeEl.textContent = 'ìš´ì˜ì§„'; badgeEl.className = 'role-badge role-manager'; }
        
        loadUsersRealtime();
      }
    });

    // 2. ì‹¤ì‹œê°„ ìœ ì € ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadUsersRealtime() {
      db.collection("users").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
        allUsers = [];
        snapshot.forEach((doc) => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        renderUsers();
      });
    }

    // 3. í•„í„°ë§ í•¨ìˆ˜
    function filterUsers(role, btnElement) {
      currentFilter = role;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      btnElement.classList.add('active');
      renderUsers();
    }

    // 4. ê¶Œí•œ ì²´ê³„ì— ë”°ë¥¸ UI ë Œë”ë§
    function renderUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";

      const filteredUsers = currentFilter === 'all' 
        ? allUsers 
        : allUsers.filter(u => u.role === currentFilter);

      if (filteredUsers.length === 0) {
        list.innerHTML = "<p style='color:#aaa;'>ì¡°ê±´ì— ë§ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      filteredUsers.forEach(u => {
        // ë±ƒì§€ ì´ë¦„ ë§¤í•‘
        const roleNames = { admin: 'ê´€ë¦¬ì', manager: 'ìš´ì˜ì§„', member: 'ì¼ë°˜ë©¤ë²„', pending: 'ìŠ¹ì¸ëŒ€ê¸°' };
        const roleName = roleNames[u.role] || u.role;
        const roleClass = `role-${u.role}`;

        let actionButtons = '';

        // [í•µì‹¬ ë¡œì§] ë‚´ ê¶Œí•œê³¼ íƒ€ê²Ÿ ìœ ì €ì˜ ê¶Œí•œì— ë”°ë¼ ë²„íŠ¼ì„ ë‹¤ë¥´ê²Œ ë…¸ì¶œ
        if (u.role === 'pending') {
          // ëŒ€ê¸°ìëŠ” ê´€ë¦¬ì/ìš´ì˜ì§„ ëª¨ë‘ ìŠ¹ì¸ ê°€ëŠ¥
          actionButtons = `<button class="btn-action btn-approve" onclick="changeRole('${u.id}', 'member')">ë©¤ë²„ ìŠ¹ì¸</button>`;
        } 
        else if (u.role === 'member') {
          // ë©¤ë²„ëŠ” ê´€ë¦¬ì/ìš´ì˜ì§„ ëª¨ë‘ ëŒ€ê¸°(ê°•ë“±) ê°€ëŠ¥
          actionButtons += `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'pending')">ëŒ€ê¸° ê°•ë“±</button> `;
          // ìµœê³  ê´€ë¦¬ìë§Œ ìš´ì˜ì§„/ê´€ë¦¬ì ì„ëª… ê°€ëŠ¥
          if (myRole === 'admin') {
            actionButtons += `<button class="btn-action btn-manager" onclick="changeRole('${u.id}', 'manager')">ìš´ì˜ì§„ ì„ëª…</button> `;
            actionButtons += `<button class="btn-action btn-admin" onclick="changeRole('${u.id}', 'admin')">ê´€ë¦¬ì ì„ëª…</button>`;
          }
        } 
        else if (u.role === 'manager') {
          // ìš´ì˜ì§„ì€ ìµœê³  ê´€ë¦¬ìë§Œ ì¡°ì‘ ê°€ëŠ¥ (ì¼ë°˜ë©¤ë²„ ê°•ë“±)
          if (myRole === 'admin') {
            actionButtons = `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'member')">ë©¤ë²„ë¡œ ê°•ë“±</button>`;
          }
        } 
        else if (u.role === 'admin') {
          // ê´€ë¦¬ìëŠ” ìµœê³  ê´€ë¦¬ì ë³¸ì¸(ë˜ëŠ” ë‹¤ë¥¸ ê´€ë¦¬ì)ë§Œ ì¡°ì‘ ê°€ëŠ¥
          // (ìŠ¤ìŠ¤ë¡œ ê°•ë“±í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ê²Œ ë‘ , í•„ìš”ì‹œ u.id !== currentUser.uid ì¡°ê±´ ì¶”ê°€ ê°€ëŠ¥)
          if (myRole === 'admin') {
            actionButtons = `<button class="btn-action btn-demote" onclick="changeRole('${u.id}', 'manager')">ìš´ì˜ì§„ìœ¼ë¡œ ê°•ë“±</button>`;
          }
        }

        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <div class="user-info">
            <span class="user-name">${u.nickname || 'ì´ë¦„ ì—†ìŒ'} <span class="role-badge ${roleClass}">${roleName}</span></span>
            <span class="user-email">${u.email}</span>
          </div>
          <div class="action-group">
            ${actionButtons}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // 5. ê¶Œí•œ ë³€ê²½ ì‹¤í–‰ (DB ì—…ë°ì´íŠ¸)
    async function changeRole(uid, newRole) {
      const roleNames = { member: "ì¼ë°˜ ë©¤ë²„", manager: "ìš´ì˜ì§„", admin: "ê´€ë¦¬ì", pending: "ìŠ¹ì¸ ëŒ€ê¸°" };
      
      // ë³´ì•ˆ 2ì°¨ ì²´í¬ (í™”ë©´ ë°–ì—ì„œ ì„ì˜ë¡œ ì¡°ì‘í•˜ë ¤ëŠ” ì‹œë„ ì°¨ë‹¨)
      if (myRole === 'manager' && (newRole === 'admin' || newRole === 'manager')) {
        return alert("ìš´ì˜ì§„ì€ í•´ë‹¹ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

      if (!confirm(`ì •ë§ë¡œ ì´ ìœ ì €ì˜ ê¶Œí•œì„ [${roleNames[newRole]}](ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        await db.collection("users").doc(uid).update({ role: newRole });
      } catch (error) {
        alert("ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨: " + error.message);
      }
    }
  </script>
</body>
</html>