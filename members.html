<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ê¸¸ë“œì› ëª©ë¡</title>

  <link rel="stylesheet" href="header_standard.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    
    h2 { color: #f4c430; margin-top: 0; margin-bottom: 10px; }
    .desc { color: #aaa; margin-bottom: 30px; line-height: 1.5; font-size: 15px; }

    /* ë©¤ë²„ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .member-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }

    /* ë©¤ë²„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .member-card {
      background: #1c1f2a; border: 1px solid #2a3242; border-radius: 12px;
      padding: 20px; display: flex; align-items: center; gap: 15px;
      transition: transform 0.2s;
    }
    .member-card:hover { transform: translateY(-3px); border-color: #444; }

    /* ì„ì‹œ í”„ë¡œí•„ ì´ë¯¸ì§€ */
    .profile-img {
      width: 50px; height: 50px; border-radius: 50%;
      background: #2a3242; display: flex; align-items: center; justify-content: center;
      font-size: 24px; font-weight: bold; color: #fff; flex-shrink: 0;
    }

    /* í…ìŠ¤íŠ¸ ì˜ì—­ */
    .info-box { display: flex; flex-direction: column; gap: 5px; overflow: hidden; }
    .nickname { font-size: 18px; font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* ì§ì±… ë±ƒì§€ */
    .role-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; width: max-content; }
    .role-member { background: #00e676; color: #000; }
    .role-manager { background: #00b0ff; color: #fff; }
    .role-admin { background: #ff5252; color: #fff; }

    /* ì´ ì¸ì›ìˆ˜ ì¹´ìš´íŠ¸ */
    .count-box { font-size: 14px; color: #00e676; font-weight: bold; margin-bottom: 20px; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <h2>ğŸ‘¥ ê¸¸ë“œì› ëª©ë¡</h2>
    <p class="desc">í˜„ì¬ ROIDER ê¸¸ë“œì— ì†Œì†ëœ ìë‘ìŠ¤ëŸ¬ìš´ ë©¤ë²„ë“¤ì…ë‹ˆë‹¤.</p>
    
    <div class="count-box" id="memberCount">ì´ ì¸ì›: ë¡œë”©ì¤‘...</div>

    <div id="memberList" class="member-grid">
      <p style="color:#aaa;">ê¸¸ë“œì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>

  <script>
    // 1. ì¸ì¦ ë° ì ‘ê·¼ ê¶Œí•œ í™•ì¸
    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("userName").textContent = data.nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;

        // ğŸ”¥ ìŠ¹ì¸ ëŒ€ê¸°ì(pending)ëŠ” ëª©ë¡ì„ ë³¼ ìˆ˜ ì—†ë„ë¡ ì°¨ë‹¨
        if (data.role === "pending") {
          alert("ê´€ë¦¬ìì˜ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì–´ì•¼ ê¸¸ë“œì› ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          location.replace("pending.html");
          return;
        }

        // ê¶Œí•œ í™•ì¸ì´ ëë‚˜ë©´ ë©¤ë²„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadMembersRealtime();
      }
    });

    // 2. ì‹¤ì‹œê°„ ë©¤ë²„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMembersRealtime() {
      // ëŒ€ê¸°ì(pending)ë¥¼ ì œì™¸í•œ ëª¨ë“  ë©¤ë²„ ë¶ˆëŸ¬ì˜¤ê¸°
      db.collection("users").where("role", "in", ["member", "manager", "admin"])
        .onSnapshot((snapshot) => {
          let members = [];
          snapshot.forEach((doc) => {
            members.push({ id: doc.id, ...doc.data() });
          });

          // [í•µì‹¬] ì§ì±… ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ê´€ë¦¬ì -> ìš´ì˜ì§„ -> ì¼ë°˜ë©¤ë²„)
          const roleWeight = { "admin": 1, "manager": 2, "member": 3 };
          members.sort((a, b) => {
            // 1ìˆœìœ„: ì§ì±…
            if (roleWeight[a.role] !== roleWeight[b.role]) {
              return roleWeight[a.role] - roleWeight[b.role];
            }
            // 2ìˆœìœ„: ë‹‰ë„¤ì„ ê°€ë‚˜ë‹¤ìˆœ
            const nickA = a.nickname || "";
            const nickB = b.nickname || "";
            return nickA.localeCompare(nickB);
          });

          renderMembers(members);
        });
    }

    // 3. í™”ë©´ì— ë©¤ë²„ ì¹´ë“œ ê·¸ë¦¬ê¸°
    function renderMembers(members) {
      const list = document.getElementById("memberList");
      const countBox = document.getElementById("memberCount");
      list.innerHTML = "";

      countBox.textContent = `í˜„ì¬ ì´ ì¸ì›: ${members.length}ëª…`;

      if (members.length === 0) {
        list.innerHTML = "<p style='color:#aaa;'>í‘œì‹œí•  ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      members.forEach(m => {
        // ë±ƒì§€ ì´ë¦„ ë§¤í•‘
        const roleNames = { admin: 'ğŸ‘‘ ìµœê³  ê´€ë¦¬ì', manager: 'ğŸ›¡ï¸ ìš´ì˜ì§„', member: 'âš”ï¸ ì¼ë°˜ ë©¤ë²„' };
        const roleName = roleNames[m.role] || m.role;
        const roleClass = `role-${m.role}`;

        // ì´ë¦„ ì²« ê¸€ìë¥¼ ê°€ì ¸ì™€ì„œ í”„ë¡œí•„ ì•„ë°”íƒ€ë¡œ ì‚¬ìš©
        const firstLetter = m.nickname ? m.nickname.charAt(0).toUpperCase() : "?";

        const div = document.createElement("div");
        div.className = "member-card";
        div.innerHTML = `
          <div class="profile-img">${firstLetter}</div>
          <div class="info-box">
            <span class="nickname">${m.nickname || 'ì´ë¦„ ì—†ìŒ'}</span>
            <span class="role-badge ${roleClass}">${roleName}</span>
          </div>
        `;
        list.appendChild(div);
      });
    }
  </script>
</body>
</html>