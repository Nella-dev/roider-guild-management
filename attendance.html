<!DOCTYPE html>
<html lang="ko">
<head>
     <link rel="stylesheet" href="header_standard.css">
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ROIDER · 출석부</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>


</head>
<body>

<header>
  <div class="logo" id="appTitle">ROIDER</div>
  <div class="user-box">
    <img id="userPhoto" src="" alt="profile" />
    <span id="userName">Loading...</span>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="card muted" id="statusBox">로그인 확인 중...</div>

  <div class="card">
    <h3>오늘 출석</h3>
    <input id="laby" type="number" placeholder="이계 점수"/>
    <input id="duel" type="number" placeholder="명결 점수"/>
    <button onclick="submitAttendance()">출석 등록</button>
  </div>

  <div class="card">
    <h3>내 출석 기록</h3>
    <div id="log" class="muted">불러오는 중...</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbqEcGsdSDBZs8PjiI05YRNEGupLf3nSc",
  authDomain: "roider-guild-management.firebaseapp.com",
  projectId: "roider-guild-management",
  storageBucket: "roider-guild-management.firebasestorage.app",
  messagingSenderId: "1012249034459",
  appId: "1:1012249034459:web:ec0f821f29170446af96fe"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

document.addEventListener("DOMContentLoaded", () => {
  const title = document.getElementById("appTitle");
  if (title) {
    title.style.cursor = "pointer";
    title.onclick = () => location.href = "main.html";
  }
});

auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const userPhoto = document.getElementById("userPhoto");
  const userName = document.getElementById("userName");
  if (user.photoURL) userPhoto.src = user.photoURL;

  const snap = await db.collection("users").doc(user.uid).get();
  const data = snap.exists ? snap.data() : {};
  userName.innerText = data.nickname || user.displayName || user.email || "User";

  document.getElementById("statusBox").innerText = "출석 등록 가능";
  await loadMyLogs(user.uid);
});

async function submitAttendance(){
  const user = auth.currentUser;
  if (!user) return;

  const laby = Number(document.getElementById("laby").value || 0);
  const duel = Number(document.getElementById("duel").value || 0);
  const todayKey = new Date().toISOString().slice(0,10);

  const ref = db.collection("attendance_logs")
                .doc(user.uid)
                .collection("days")
                .doc(todayKey);

  const snap = await ref.get();
  if (snap.exists) {
    alert("오늘은 이미 출석했습니다.");
    return;
  }

  await ref.set({
    laby,
    duel,
    date: todayKey,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("출석 완료!");
  await loadMyLogs(user.uid);
}

async function loadMyLogs(uid){
  const el = document.getElementById("log");
  el.innerHTML = "";

  const snap = await db
    .collection("attendance_logs")
    .doc(uid)
    .collection("days")
    .orderBy("date", "desc")
    .get();

  if (snap.empty) {
    el.innerText = "아직 출석 기록이 없습니다.";
    return;
  }

  snap.forEach(d => {
    const v = d.data();
    const div = document.createElement("div");
    div.className = "row";
    div.innerText = `${v.date} | 이계: ${v.laby} / 명결: ${v.duel}`;
    el.appendChild(div);
  });
}

function logout(){
  auth.signOut().then(() => location.href = "login.html");
}
</script>

</body>
</html>