<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ìº˜ë¦°ë” ì¶œì„ë¶€</title>

  <link rel="stylesheet" href="header_standard.css">
  
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    #calendar { background: #1c1f2a; padding: 20px; border-radius: 12px; border: 1px solid #2a3242; }
    .fc-theme-standard th { background: #121721; color: #f4c430; padding: 10px 0; border-color: #2a3242; }
    .fc-theme-standard td, .fc-theme-standard .fc-scrollgrid { border-color: #2a3242; }
    .fc-day-today { background: rgba(244, 196, 48, 0.1) !important; }
    .fc-daygrid-day:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
    
    /* ğŸ’¡ ì¶œì„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì´ë²¤íŠ¸ ë¸”ë¡ì„ ë²„íŠ¼ì²˜ëŸ¼ ê¾¸ë°ˆ) */
    .event-pending { 
      background: #f4c430 !important; border: none !important; color: #111 !important; 
      font-weight: bold; text-align: center; padding: 6px 2px; border-radius: 6px; 
      cursor: pointer; margin-top: 5px; font-size: 13px;
    }
    .event-completed { 
      background: #00e676 !important; border: none !important; color: #000 !important; 
      font-weight: bold; text-align: center; padding: 6px 2px; border-radius: 6px; 
      cursor: pointer; margin-top: 5px; font-size: 13px;
    }
    .event-pending:hover { background: #d4a924 !important; }
    .event-completed:hover { background: #00c853 !important; }
    
    /* ë¯¸ë˜ ë‚ ì§œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .fc-day-future { background: rgba(255, 255, 255, 0.02) !important; cursor: not-allowed !important; opacity: 0.4; }

    /* ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1c1f2a; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid #f4c430; }
    .modal h3 { color: #f4c430; margin-top: 0; text-align: center; }
    
    .penalty-warning { display: none; background: rgba(255, 82, 82, 0.1); color: #ff5252; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold; text-align: center; margin-bottom: 15px; border: 1px solid #ff5252; }

    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 5px; color: #aaa; }
    .input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; }
    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
    .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-save { background: #f4c430; color: #111; }
    .btn-close { background: #444; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <h2 style="color: #f4c430;">ğŸ“… í™œë™ ìº˜ë¦°ë” (ë¦¬ì…‹: UTC 00ì‹œ)</h2>
    <p style="color: #aaa; margin-bottom: 20px;">'ì¶œì„í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ê³¼ê±° ì¶œì„ ì‹œ 50% íŒ¨ë„í‹°)</p>
    
    <div id="calendar"></div>
  </div>

  <div class="modal-overlay" id="attendanceModal">
    <div class="modal">
      <h3 id="modalDateTitle">0000-00-00 ì¶œì„</h3>
      
      <div id="penaltyWarning" class="penalty-warning">
        âš ï¸ ê³¼ê±° ë‚ ì§œì…ë‹ˆë‹¤.<br>ì…ë ¥í•˜ì‹  ì ìˆ˜ì˜ 50%ë§Œ ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>
      
      <div class="input-group">
        <label>âš”ï¸ ì´ê³„ ì ìˆ˜</label>
        <input type="number" id="labyScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>
      <div class="input-group">
        <label>ğŸ›¡ï¸ ëª…ê²° ì ìˆ˜</label>
        <input type="number" id="duelScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>
      <div class="input-group">
        <label>ğŸ”¥ ê¸¸ë“œ í™œì•½ë„ ì ìˆ˜</label>
        <input type="number" id="activityScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>

      <div class="modal-btns">
        <button class="btn-close" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn-save" onclick="saveAttendance()">ê¸°ë¡ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let calendar = null;
    let selectedDate = "";
    let isPastDate = false;
    let todayGameDateStr = "";

    // [UTC ê¸°ì¤€ ë‚ ì§œ ê³„ì‚° ë¡œì§]
    function getGameDate() {
      const now = new Date();
      const utcTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
      utcTime.setDate(utcTime.getDate() - 1); // 00ì‹œ ê¸°ì¤€ ì–´ì œ
      
      const y = utcTime.getFullYear();
      const m = String(utcTime.getMonth() + 1).padStart(2, '0');
      const d = String(utcTime.getDate()).padStart(2, '0');
      
      return `${y}-${m}-${d}`;
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      currentUser = user;
      
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        document.getElementById("userName").textContent = docSnap.data().nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;
      }

      todayGameDateStr = getGameDate(); 
      initCalendar();
    });

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        height: 'auto',
        
        dayCellDidMount: function(info) {
          const cellDateStr = info.date.getFullYear() + '-' + String(info.date.getMonth() + 1).padStart(2, '0') + '-' + String(info.date.getDate()).padStart(2, '0');
          if (cellDateStr > todayGameDateStr) {
            info.el.classList.add('fc-day-future'); 
          }
        },

        // ë‹¬ë ¥ ë¹ˆì¹¸ í´ë¦­ ì‹œ
        dateClick: function(info) {
          handleDateClick(info.dateStr);
        },
        
        // ìƒì„±ëœ ë²„íŠ¼(ì´ë²¤íŠ¸) í´ë¦­ ì‹œ
        eventClick: function(info) {
          handleDateClick(info.event.startStr);
        },

        // ğŸ’¡ [í•µì‹¬] ë‹¬ë ¥ì— 'ì¶œì„í•˜ê¸°' ë° 'ì¶œì„ì™„ë£Œ' ë²„íŠ¼ì„ ê·¸ë¦¬ëŠ” ë¡œì§
        events: async function(info, successCallback, failureCallback) {
          try {
            // ë‚´ ê¸°ë¡ì„ ì „ë¶€ ê°€ì ¸ì˜´
            const snap = await db.collection("attendance_logs").doc(currentUser.uid).collection("days").get();
            const completedDays = new Set();
            snap.forEach(doc => { completedDays.add(doc.id); });

            const events = [];
            
            // ë‹¬ë ¥ì— í‘œì‹œë˜ëŠ” ì²«ë‚ ë¶€í„° ëë‚ ê¹Œì§€ ëŒë©´ì„œ ë²„íŠ¼ ìƒì„±
            let currentDate = new Date(info.start);
            const endDate = new Date(info.end);

            while (currentDate < endDate) {
              const y = currentDate.getFullYear();
              const m = String(currentDate.getMonth() + 1).padStart(2, '0');
              const d = String(currentDate.getDate()).padStart(2, '0');
              const dateStr = `${y}-${m}-${d}`;

              // ê²Œì„ ê¸°ì¤€ì¼(ì˜¤ëŠ˜)ê¹Œì§€ë§Œ ë²„íŠ¼ì„ í‘œì‹œ
              if (dateStr <= todayGameDateStr) {
                if (completedDays.has(dateStr)) {
                  // ì´ë¯¸ ì¶œì„í•œ ë‚  -> ì´ˆë¡ìƒ‰ ì™„ë£Œ ë²„íŠ¼
                  events.push({ title: 'âœ… ì¶œì„ì™„ë£Œ', start: dateStr, allDay: true, className: 'event-completed' });
                } else {
                  // ì¶œì„ ì•ˆ í•œ ë‚  -> ë…¸ë€ìƒ‰ ì¶œì„ ë²„íŠ¼
                  events.push({ title: 'ğŸ‘† ì¶œì„í•˜ê¸°', start: dateStr, allDay: true, className: 'event-pending' });
                }
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
            successCallback(events);
          } catch (error) {
            console.error(error);
            failureCallback(error);
          }
        }
      });
      calendar.render();
    }

    // ë‚ ì§œ í´ë¦­ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
    function handleDateClick(clickedDate) {
      if (clickedDate > todayGameDateStr) {
        return alert("ì•„ì§ ì˜¤í”ˆë˜ì§€ ì•Šì€ ë¯¸ë˜ì˜ ë‚ ì§œëŠ” ì¶œì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      isPastDate = (clickedDate < todayGameDateStr);
      openModal(clickedDate);
    }

    function openModal(dateStr) {
      selectedDate = dateStr;
      document.getElementById("modalDateTitle").textContent = dateStr + " í™œë™ ê¸°ë¡";
      
      document.getElementById("labyScore").value = "";
      document.getElementById("duelScore").value = "";
      document.getElementById("activityScore").value = "";
      
      if (isPastDate) {
        document.getElementById("penaltyWarning").style.display = "block";
      } else {
        document.getElementById("penaltyWarning").style.display = "none";
      }

      document.getElementById("attendanceModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("attendanceModal").style.display = "none";
    }

    async function saveAttendance() {
      let laby = Number(document.getElementById("labyScore").value || 0);
      let duel = Number(document.getElementById("duelScore").value || 0);
      let activity = Number(document.getElementById("activityScore").value || 0);

      // ê³¼ê±° ì¶œì„ íŒ¨ë„í‹° 50%
      if (isPastDate) {
        laby = laby * 0.5;
        duel = duel * 0.5;
        activity = activity * 0.5;
      }

      try {
        await db.collection("attendance_logs").doc(currentUser.uid).collection("days").doc(selectedDate).set({
          date: selectedDate,
          laby: laby,
          duel: duel,
          activity: activity,
          isPenaltyApplied: isPastDate,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        let msg = "ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
        if(isPastDate) msg += "\n(ê³¼ê±° ì¶œì„ìœ¼ë¡œ ì¸í•´ ì ìˆ˜ê°€ 50% ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.)";
        
        alert(msg);
        closeModal();
        // ğŸ’¡ ì €ì¥ ì„±ê³µ ì‹œ ë‹¬ë ¥ ë²„íŠ¼ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë…¸ë€ ë²„íŠ¼ì„ ì´ˆë¡ ë²„íŠ¼ìœ¼ë¡œ ë°”ê¿ˆ
        calendar.refetchEvents();
      } catch (error) {
        alert("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: " + error.message);
      }
    }
  </script>
</body>
</html>