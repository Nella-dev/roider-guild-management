<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì¶œì„ë¶€</title>

  <link rel="stylesheet" href="header_standard.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 800px; margin: 40px auto; padding: 20px; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 20px; border: 1px solid #2a3242; }
    h2 { color: #f4c430; margin-top: 0; }
    
    .input-group { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
    input[type="number"], input[type="date"] {
      padding: 10px; border-radius: 8px; border: 1px solid #444; background: #2a3242; color: #fff;
    }
    button.submit-btn {
      padding: 10px 20px; border-radius: 8px; border: none; background: #f4c430; color: #111; font-weight: bold; cursor: pointer;
    }
    .log-list { margin-top: 20px; }
    .log-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #2a3242; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>ğŸ“… ì˜¤ëŠ˜ì˜ í™œë™ ê¸°ë¡</h2>
      <p>ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì´ê³„/ëª…ê²° ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
      
      <div class="input-group">
        <input type="date" id="dateInput">
        <input type="number" id="labyInput" placeholder="ì´ê³„ ì ìˆ˜" min="0">
        <input type="number" id="duelInput" placeholder="ëª…ê²° ì ìˆ˜" min="0">
        <button class="submit-btn" onclick="saveAttendance()">ê¸°ë¡ ì €ì¥</button>
      </div>

      <h3>ë‚˜ì˜ ìµœê·¼ ì¶œì„ ê¸°ë¡</h3>
      <div id="log" class="log-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

  <script>
    let currentUser = null;

    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¸íŒ…
    document.getElementById("dateInput").value = new Date().toISOString().substring(0, 10);

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      currentUser = user;

      // í—¤ë” í”„ë¡œí•„ ì—…ë°ì´íŠ¸
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        document.getElementById("userName").textContent = docSnap.data().nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;
      }
      
      loadMyLogs();
    });

    // 1. ì¶œì„ ì €ì¥ ë¡œì§ (Firestore ì—°ë™)
    async function saveAttendance() {
      if (!currentUser) return;
      
      const date = document.getElementById("dateInput").value;
      const laby = Number(document.getElementById("labyInput").value || 0);
      const duel = Number(document.getElementById("duelInput").value || 0);

      if (!date) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

      try {
        await db.collection("attendance_logs").doc(currentUser.uid).collection("days").doc(date).set({
          date: date,
          laby: laby,
          duel: duel,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        loadMyLogs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        alert("ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
      }
    }

    // 2. ë‚´ ì¶œì„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMyLogs() {
      const logContainer = document.getElementById("log");
      const snap = await db.collection("attendance_logs").doc(currentUser.uid)
                           .collection("days").orderBy("date", "desc").limit(7).get();
      
      if (snap.empty) {
        logContainer.innerHTML = "<p style='color:#aaa'>ì•„ì§ ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      let html = "";
      snap.forEach(doc => {
        const data = doc.data();
        html += `
          <div class="log-item">
            <span>${data.date}</span>
            <span>ì´ê³„: <b style="color:#f4c430">${data.laby}</b> / ëª…ê²°: <b style="color:#00e676">${data.duel}</b></span>
          </div>
        `;
      });
      logContainer.innerHTML = html;
    }
  </script>
</body>
</html>