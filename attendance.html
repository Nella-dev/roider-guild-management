<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ìº˜ë¦°ë” ì¶œì„ë¶€</title>

  <link rel="stylesheet" href="header_standard.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_key.js"></script>
  <script src="firebase_config.js"></script>
  <script src="i18n.js"></script>

  <style>
    body { margin: 0; background: radial-gradient(circle at top, #1b2333, #0f1015 60%); color: #e6e6e6; min-height: 100vh; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    
    #calendar { background: #1c1f2a; padding: 20px; border-radius: 12px; border: 1px solid #2a3242; font-weight: 500; }
    .fc-theme-standard th { background: #121721; color: #f4c430; padding: 10px 0; border-color: #2a3242; font-weight: 700; }
    .fc-theme-standard td, .fc-theme-standard .fc-scrollgrid { border-color: #2a3242; }
    .fc-day-today { background: rgba(244, 196, 48, 0.08) !important; }
    .fc-daygrid-day:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
    
    .event-pending { background: #f4c430 !important; border: none !important; color: #111 !important; font-weight: 700; text-align: center; padding: 6px 2px; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 13.5px; }
    .event-past-pending { background: #2a3242 !important; border: 1px solid #444 !important; color: #aaa !important; font-weight: 600; text-align: center; padding: 5px 2px; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 13.5px; transition: 0.2s; }
    .event-past-pending:hover { background: #3a445a !important; color: #fff !important; }
    .event-completed { background: #00e676 !important; border: none !important; color: #000 !important; font-weight: 700; text-align: center; padding: 6px 2px; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 13.5px; }
    .fc-day-future { background: rgba(255, 255, 255, 0.02) !important; cursor: not-allowed !important; opacity: 0.4; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1c1f2a; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid #f4c430; }
    .modal h3 { color: #f4c430; margin-top: 0; text-align: center; font-weight: 800; }
    
    .penalty-warning { display: none; background: rgba(255, 82, 82, 0.1); color: #ff5252; padding: 12px; border-radius: 8px; font-size: 13.5px; font-weight: 700; text-align: center; margin-bottom: 15px; border: 1px solid #ff5252; line-height: 1.4; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 6px; color: #bbb; font-weight: 600; }
    .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; font-family: inherit; font-size: 15px; }
    .modal-btns { display: flex; gap: 10px; margin-top: 24px; }
    .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-family: inherit; font-size: 15px; }
    .btn-save { background: #f4c430; color: #111; }
    .btn-close { background: #444; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="" alt="profile" style="width:32px; height:32px; border-radius:50%;" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      
      <button id="langToggleBtn" class="logout" onclick="toggleLanguage()" style="color:#f4c430; border-color:#f4c430;">ğŸŒ EN</button>
      <button class="logout" onclick="logout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link" data-i18n="menu_home">í™ˆ</a>
      <a href="notice.html" class="nav-link" data-i18n="menu_notice">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link" data-i18n="menu_calendar">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link" data-i18n="menu_weekly">ì£¼ê°„ ê²°ì‚°</a>
      <a href="strategy.html" class="nav-link" data-i18n="menu_strategy">ì‘ì „ ì§€ë„</a>
      <a href="members.html" class="nav-link" data-i18n="menu_members">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none; color: #ff5252;" data-i18n="menu_admin">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>

  <div class="wrap">
    <h2 style="color: #f4c430; font-weight: 800;" data-i18n="att_title">ğŸ“… í™œë™ ìº˜ë¦°ë” (ë¦¬ì…‹: UTC 00ì‹œ)</h2>
    <p style="color: #aaa; margin-bottom: 20px;" data-i18n="att_desc">'ì¶œì„í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ê³¼ê±° ì¶œì„ ì‹œ 50% íŒ¨ë„í‹°)</p>
    
    <div id="calendar"></div>
  </div>

  <div class="modal-overlay" id="attendanceModal">
    <div class="modal">
      <h3 id="modalDateTitle">0000-00-00 <span data-i18n="att_modal_title">í™œë™ ê¸°ë¡</span></h3>
      
      <div id="penaltyWarning" class="penalty-warning" data-i18n="att_warning">
        âš ï¸ ê³¼ê±° ë‚ ì§œì…ë‹ˆë‹¤.<br>ì…ë ¥í•˜ì‹  ì ìˆ˜ì˜ 50%ë§Œ ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>
      
      <div class="input-group">
        <label data-i18n="att_laby">âš”ï¸ Arcane Labyrinth</label>
        <input type="number" id="labyScore" min="0">
      </div>
      <div class="input-group">
        <label data-i18n="att_duel">ğŸ›¡ï¸ Honor Duel</label>
        <input type="number" id="duelScore" min="0">
      </div>
      <div class="input-group">
        <label data-i18n="att_activity">ğŸ”¥ ê¸¸ë“œ í™œì•½ë„ ì ìˆ˜</label>
        <input type="number" id="activityScore" min="0">
      </div>

      <div class="modal-btns">
        <button class="btn-close" onclick="closeModal()" data-i18n="att_btn_cancel">ì·¨ì†Œ</button>
        <button class="btn-save" onclick="saveAttendance()" data-i18n="att_btn_save">ê¸°ë¡ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let calendar = null;
    let selectedDate = "";
    let isPastDate = false;
    let todayGameDateStr = "";

    // ğŸ’¡ ì›ë˜ ë§Œë“œì‹  ê²Œì„ ë‚ ì§œ ë¡œì§ ë³´ì¡´
    function getGameDate() {
      const now = new Date();
      const utcTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
      utcTime.setDate(utcTime.getDate() - 1); 
      const y = utcTime.getFullYear();
      const m = String(utcTime.getMonth() + 1).padStart(2, '0');
      const d = String(utcTime.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      currentUser = user;
      todayGameDateStr = getGameDate(); 
      initCalendar();
    });

    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: currentLang === 'en' ? 'en' : 'ko',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        height: 'auto',
        
        dayCellDidMount: function(info) {
          const cellDateStr = info.date.getFullYear() + '-' + String(info.date.getMonth() + 1).padStart(2, '0') + '-' + String(info.date.getDate()).padStart(2, '0');
          if (cellDateStr > todayGameDateStr) {
            info.el.classList.add('fc-day-future'); 
          }
        },

        dateClick: function(info) { handleDateClick(info.dateStr); },
        eventClick: function(info) { handleDateClick(info.event.startStr); },

        events: async function(info, successCallback, failureCallback) {
          try {
            const snap = await db.collection("attendance_logs").doc(currentUser.uid).collection("days").get();
            const completedDays = new Set();
            snap.forEach(doc => { completedDays.add(doc.id); });

            const events = [];
            let currentDate = new Date(info.start);
            const endDate = new Date(info.end);

            const textDone = i18n[currentLang]["att_btn_done"];
            const textPast = i18n[currentLang]["att_btn_past"];
            const textToday = i18n[currentLang]["att_btn_today"];

            while (currentDate < endDate) {
              const y = currentDate.getFullYear();
              const m = String(currentDate.getMonth() + 1).padStart(2, '0');
              const d = String(currentDate.getDate()).padStart(2, '0');
              const dateStr = `${y}-${m}-${d}`;

              if (dateStr <= todayGameDateStr) {
                if (completedDays.has(dateStr)) {
                  events.push({ title: textDone, start: dateStr, allDay: true, className: 'event-completed' });
                } else {
                  if (dateStr < todayGameDateStr) {
                    events.push({ title: textPast, start: dateStr, allDay: true, className: 'event-past-pending' });
                  } else {
                    events.push({ title: textToday, start: dateStr, allDay: true, className: 'event-pending' });
                  }
                }
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
            successCallback(events);
          } catch (error) { failureCallback(error); }
        }
      });
      calendar.render();
    }

    function handleDateClick(clickedDate) {
      if (clickedDate > todayGameDateStr) return;
      isPastDate = (clickedDate < todayGameDateStr);
      openModal(clickedDate);
    }

    function openModal(dateStr) {
      selectedDate = dateStr;
      document.getElementById("modalDateTitle").innerHTML = `${dateStr} <span data-i18n="att_modal_title">${i18n[currentLang]["att_modal_title"]}</span>`;
      
      document.getElementById("labyScore").value = "";
      document.getElementById("duelScore").value = "";
      document.getElementById("activityScore").value = "";
      
      document.getElementById("penaltyWarning").style.display = isPastDate ? "block" : "none";
      document.getElementById("attendanceModal").style.display = "flex";
    }

    function closeModal() { document.getElementById("attendanceModal").style.display = "none"; }

    // ğŸ’¡ ì›ë˜ ë§Œë“œì‹  íŒ¨ë„í‹° ì ìš© ë¡œì§ ë³´ì¡´
    async function saveAttendance() {
      let laby = Number(document.getElementById("labyScore").value || 0);
      let duel = Number(document.getElementById("duelScore").value || 0);
      let activity = Number(document.getElementById("activityScore").value || 0);

      if (isPastDate) {
        laby = laby * 0.5; duel = duel * 0.5; activity = activity * 0.5;
      }

      try {
        await db.collection("attendance_logs").doc(currentUser.uid).collection("days").doc(selectedDate).set({
          date: selectedDate, laby: laby, duel: duel, activity: activity,
          isPenaltyApplied: isPastDate, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        calendar.refetchEvents();
      } catch (error) { alert("Error: " + error.message); }
    }
  </script>
</body>
</html>