<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ìº˜ë¦°ë” ì¶œì„ë¶€</title>

  <link rel="stylesheet" href="header_standard.css">
  
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; font-family: Pretendard, system-ui; background: #0f1015; color: #e6e6e6; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
    
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    #calendar { background: #1c1f2a; padding: 20px; border-radius: 12px; border: 1px solid #2a3242; }
    .fc-theme-standard th { background: #121721; color: #f4c430; padding: 10px 0; border-color: #2a3242; }
    .fc-theme-standard td, .fc-theme-standard .fc-scrollgrid { border-color: #2a3242; }
    .fc-day-today { background: rgba(244, 196, 48, 0.1) !important; }
    .fc-daygrid-day:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
    .fc-h-event { background: #00e676; border: none; color: #000; font-weight: bold; padding: 2px 4px; border-radius: 4px; text-align: center;}
    
    /* ë¯¸ë˜ ë‚ ì§œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .fc-day-future { background: rgba(255, 255, 255, 0.02) !important; cursor: not-allowed !important; opacity: 0.4; }

    /* ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1c1f2a; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid #f4c430; }
    .modal h3 { color: #f4c430; margin-top: 0; text-align: center; }
    
    /* ê³¼ê±° ì¶œì„ íŒ¨ë„í‹° ê²½ê³ ë¬¸ */
    .penalty-warning { display: none; background: rgba(255, 82, 82, 0.1); color: #ff5252; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold; text-align: center; margin-bottom: 15px; border: 1px solid #ff5252; }

    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 5px; color: #aaa; }
    .input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; }
    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
    .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-save { background: #f4c430; color: #111; }
    .btn-close { background: #444; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <h2 style="color: #f4c430;">ğŸ“… í™œë™ ìº˜ë¦°ë” (ë¦¬ì…‹: ì˜¤ì „ 09ì‹œ)</h2>
    <p style="color: #aaa; margin-bottom: 20px;">ì¶œì„í•  ë‚ ì§œ(ì¹¸)ë¥¼ í´ë¦­í•˜ì—¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ê³¼ê±° ì¶œì„ ì‹œ 50% íŒ¨ë„í‹°)</p>
    
    <div id="calendar"></div>
  </div>

  <div class="modal-overlay" id="attendanceModal">
    <div class="modal">
      <h3 id="modalDateTitle">0000-00-00 ì¶œì„</h3>
      
      <div id="penaltyWarning" class="penalty-warning">
        âš ï¸ ê³¼ê±° ë‚ ì§œì…ë‹ˆë‹¤.<br>ì…ë ¥í•˜ì‹  ì ìˆ˜ì˜ 50%ë§Œ ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>
      
      <div class="input-group">
        <label>âš”ï¸ ì´ê³„ ì ìˆ˜</label>
        <input type="number" id="labyScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>
      <div class="input-group">
        <label>ğŸ›¡ï¸ ëª…ê²° ì ìˆ˜</label>
        <input type="number" id="duelScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>
      <div class="input-group">
        <label>ğŸ”¥ ê¸¸ë“œ í™œì•½ë„ ì ìˆ˜</label>
        <input type="number" id="activityScore" placeholder="ì ìˆ˜ ì…ë ¥" min="0">
      </div>

      <div class="modal-btns">
        <button class="btn-close" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn-save" onclick="saveAttendance()">ê¸°ë¡ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let calendar = null;
    let selectedDate = "";
    let isPastDate = false; // ê³¼ê±° ì—¬ë¶€ íŒë³„ ë³€ìˆ˜
    let todayGameDateStr = "";

    // [í•µì‹¬] í•œêµ­ ì‹œê°(KST) ì˜¤ì „ 9ì‹œ ê¸°ì¤€ 'ì˜¤ëŠ˜(ê²Œì„ ë‚ ì§œ)' ê³„ì‚° ë¡œì§
    function getGameDate() {
      const now = new Date();
      // ë¸Œë¼ìš°ì € ì‹œê°„ì„ UTCë¡œ ë³€í™˜ í›„, í•œêµ­ ì‹œê°„(+9ì‹œê°„)ìœ¼ë¡œ ë§ì¶¤
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const kstTime = new Date(utc + (9 * 3600000));
      
      // KST ì‹œê°„ì´ ì˜¤ì „ 9ì‹œ ì´ì „ì´ë©´, ê²Œì„ ìƒ ë‚ ì§œëŠ” ì–´ì œì…ë‹ˆë‹¤.
      if (kstTime.getHours() < 9) {
        kstTime.setDate(kstTime.getDate() - 1);
      }
      
      // YYYY-MM-DD í˜•íƒœë¡œ ë³€í™˜
      const y = kstTime.getFullYear();
      const m = String(kstTime.getMonth() + 1).padStart(2, '0');
      const d = String(kstTime.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      currentUser = user;
      
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        document.getElementById("userName").textContent = docSnap.data().nickname || "User";
        if (user.photoURL) document.getElementById("userPhoto").src = user.photoURL;
      }

      todayGameDateStr = getGameDate(); // ì ‘ì† ì‹œ ê²Œì„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
      initCalendar();
    });

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        height: 'auto',
        
        // [ì¶”ê°€ ê¸°ëŠ¥] ë‚ ì§œ ì…€ì„ ê·¸ë¦´ ë•Œ ë¯¸ë˜ ë‚ ì§œë©´ CSS í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ë¹„í™œì„±í™”
        dayCellDidMount: function(info) {
          const cellDateStr = info.date.getFullYear() + '-' + String(info.date.getMonth() + 1).padStart(2, '0') + '-' + String(info.date.getDate()).padStart(2, '0');
          if (cellDateStr > todayGameDateStr) {
            info.el.classList.add('fc-day-future'); // CSSì—ì„œ í´ë¦­ ë¶ˆê°€ ë° ì–´ë‘¡ê²Œ ì²˜ë¦¬ë¨
          }
        },

        // í´ë¦­ ì´ë²¤íŠ¸ ì œì–´
        dateClick: function(info) {
          const clickedDate = info.dateStr;
          
          // 1. ë¯¸ë˜ ë‚ ì§œ ì°¨ë‹¨
          if (clickedDate > todayGameDateStr) {
            return alert("ì•„ì§ ì˜¤í”ˆë˜ì§€ ì•Šì€ ë¯¸ë˜ì˜ ë‚ ì§œëŠ” ì¶œì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
          
          // 2. ëª¨ë‹¬ ì—´ê¸° (ê³¼ê±° ë‚ ì§œì¸ì§€ ì—¬ë¶€ íŒë³„)
          isPastDate = (clickedDate < todayGameDateStr);
          openModal(clickedDate);
        },

        // ë‚´ ì¶œì„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ê³¼ ë™ì¼)
        events: async function(info, successCallback, failureCallback) {
          const snap = await db.collection("attendance_logs").doc(currentUser.uid).collection("days").get();
          const events = [];
          snap.forEach(doc => {
            events.push({ title: 'âœ… ì™„ë£Œ', start: doc.id, allDay: true });
          });
          successCallback(events);
        }
      });
      calendar.render();
    }

    // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
    function openModal(dateStr) {
      selectedDate = dateStr;
      document.getElementById("modalDateTitle").textContent = dateStr + " í™œë™ ê¸°ë¡";
      
      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      document.getElementById("labyScore").value = "";
      document.getElementById("duelScore").value = "";
      document.getElementById("activityScore").value = "";
      
      // ê³¼ê±° ì¶œì„ì¼ ê²½ìš° ê²½ê³ ë¬¸ í‘œì‹œ
      if (isPastDate) {
        document.getElementById("penaltyWarning").style.display = "block";
      } else {
        document.getElementById("penaltyWarning").style.display = "none";
      }

      document.getElementById("attendanceModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("attendanceModal").style.display = "none";
    }

    // íŒŒì´ì–´ë² ì´ìŠ¤ì— ì ìˆ˜ ì €ì¥ (íŒ¨ë„í‹° ê³„ì‚° ì ìš©)
    async function saveAttendance() {
      let laby = Number(document.getElementById("labyScore").value || 0);
      let duel = Number(document.getElementById("duelScore").value || 0);
      let activity = Number(document.getElementById("activityScore").value || 0);

      // [í•µì‹¬] ê³¼ê±° ì¶œì„ì¼ ê²½ìš° ì ìˆ˜ 50% ì°¨ê° ë¡œì§
      if (isPastDate) {
        laby = laby * 0.5;
        duel = duel * 0.5;
        activity = activity * 0.5;
      }

      try {
        await db.collection("attendance_logs").doc(currentUser.uid).collection("days").doc(selectedDate).set({
          date: selectedDate,
          laby: laby,
          duel: duel,
          activity: activity,
          isPenaltyApplied: isPastDate, // ë‚˜ì¤‘ì— ë°ì´í„°ë¥¼ ë³¼ ë•Œ íŒ¨ë„í‹°ê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        let msg = "ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
        if(isPastDate) msg += "\n(ê³¼ê±° ì¶œì„ìœ¼ë¡œ ì¸í•´ ì ìˆ˜ê°€ 50% ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.)";
        
        alert(msg);
        closeModal();
        calendar.refetchEvents();
      } catch (error) {
        alert("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: " + error.message);
      }
    }
  </script>
</body>
</html>