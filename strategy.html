<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì‘ì „ ì§€ë„</title>
  <link rel="stylesheet" href="header_standard.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_key.js"></script>
  <script src="firebase_config.js"></script>
  <script src="i18n.js"></script>
  <script src="calendar_patch.js"></script>
  <style>
    body { margin: 0; background: radial-gradient(circle at top, #1b2333, #0f1015 60%); color: #e6e6e6; min-height: 100vh; }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 20px; }
    h2 { color: #f4c430; margin-top: 0; margin-bottom: 5px; font-weight: 800; }
    .card { background: #1c1f2a; border-radius: 12px; padding: 20px; border: 1px solid #2a3242; margin-bottom: 20px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 6px; color: #bbb; font-weight: 800; }
    .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; font-family: inherit; font-size: 15px; }
    .admin-only { display: none; }
    .btn-save-strategy { background: #ff5252; color: #fff; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 16px; width: 100%; margin-top: 10px; }
    .map-wrapper { position: relative; width: 100%; background: #111; border: 2px solid #2a3242; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; }
    #mapImage { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
    .grid-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(40, 1fr); grid-template-rows: repeat(40, 1fr); z-index: 10; }
    .grid-cell { border: 1px dashed rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; }
    .cell-attack { background: rgba(255, 50, 50, 0.5); border: 2px solid #ff5252; }
    .cell-defense { background: rgba(50, 100, 255, 0.5); border: 2px solid #4dabf7; }
    .cell-admin:hover { background: rgba(255, 255, 255, 0.2); cursor: pointer; }
    .marker-icon { font-size: 24px; }
    .marker-count { font-size: 14px; font-weight: 800; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1c1f2a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #f4c430; }
    .grid-cell { border: 1px dashed rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; /* ğŸ”¥ ëª¨ë°”ì¼ í„°ì¹˜ ì •í™•ë„ í–¥ìƒ */ touch-action: manipulation; }
    @media (max-width: 768px) {
    .map-wrapper { aspect-ratio: 1 / 1; }
    .marker-icon { font-size: 16px; }
    .marker-count { font-size: 11px; }
}
  </style>
</head>
<body>
  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="" alt="profile" style="width:32px; height:32px; border-radius:50%;" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button id="langToggleBtn" class="logout" onclick="toggleLanguage()">ğŸŒ EN</button>
      <button class="logout" onclick="logout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link" data-i18n="menu_home">í™ˆ</a>
      <a href="notice.html" class="nav-link" data-i18n="menu_notice">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link" data-i18n="menu_calendar">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link" data-i18n="menu_weekly">ì£¼ê°„ ê²°ì‚°</a>
      <a href="strategy.html" class="nav-link active" data-i18n="menu_strategy">ì‘ì „ ì§€ë„</a>
      <a href="members.html" class="nav-link" data-i18n="menu_members">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none;" data-i18n="menu_admin">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>
  <div class="wrap">
    <h2 data-i18n="str_title">ğŸ—ºï¸ ëŒ€í•­ì „ ì‘ì „ ì§€ë„</h2>
    <div class="card">
      <div class="input-group">
        <label data-i18n="str_vanguard">âš”ï¸ ì„ ë´‰ ì§€ì •</label>
        <input type="text" id="vanguardInput" readonly>
      </div>
      <div class="admin-only" style="margin: 15px 0;">
        <input type="file" id="imageUpload" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
        <button onclick="document.getElementById('imageUpload').click()" data-i18n="str_upload_map">ì§€ë„ ì—…ë¡œë“œ</button>
      </div>
      <div class="map-wrapper">
        <img id="mapImage" src="" style="display:none;">
        <span id="emptyMapText" data-i18n="str_empty_map">ì§€ë„ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
        <div class="grid-overlay" id="gridOverlay"></div>
      </div>
      <button id="btnSaveStrategy" class="btn-save-strategy admin-only" onclick="saveStrategy()" data-i18n="str_btn_save">ğŸ’¾ ì‘ì „ ì €ì¥ ë° ê³µìœ </button>
    </div>
  </div>
  <div class="modal-overlay" id="cellModal">
    <div class="modal">
      <h3 data-i18n="str_modal_title">êµ¬ì—­ ì˜¤ë” ì„¤ì •</h3>
      <select id="cellType">
        <option value="none" data-i18n="str_type_none">ë¬´ë°°ì¹˜</option>
        <option value="attack" data-i18n="str_type_attack">ê³µê²©</option>
        <option value="defense" data-i18n="str_type_defense">ë°©ì–´</option>
      </select>
      <input type="number" id="cellCount" min="0">
      <div style="display:flex; gap:10px;">
        <button onclick="document.getElementById('cellModal').style.display='none'">ì·¨ì†Œ</button>
        <button onclick="applyCellData()" style="background:#f4c430;">ì ìš©</button>
      </div>
    </div>
  </div>
  <script>
    let isAdmin = false;
    let currentStrategy = { vanguard: "", mapImageBase64: "", gridData: {} };
    let editingCellIndex = -1;
    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const role = docSnap.data().role;
        if (role === "admin" || role === "manager") {
          isAdmin = true;
          document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
          document.getElementById("vanguardInput").readOnly = false;
        }
        initGrid();
        loadRealtimeStrategy();
      }
    });
   function initGrid() {

  const grid = document.getElementById("gridOverlay");
  grid.innerHTML = "";

  const totalCells = 1600;

  for (let i = 0; i < totalCells; i++) {

    const cell = document.createElement("div");
    cell.className = "grid-cell" + (isAdmin ? " cell-admin" : "");
    cell.id = `cell-${i}`;
    cell.dataset.index = i;

    if (isAdmin) {

      // ë§ˆìš°ìŠ¤ + í„°ì¹˜ ëª¨ë‘ ëŒ€ì‘
      cell.addEventListener("pointerdown", (e) => {

        e.preventDefault();

        const index = Number(cell.dataset.index);
        editingCellIndex = index;

        const data = currentStrategy.gridData[index] || { type: "none", count: 0 };

        document.getElementById("cellType").value = data.type;
        document.getElementById("cellCount").value = data.count;
        document.getElementById("cellModal").style.display = "flex";

      });

    }

    grid.appendChild(cell);
  }
}
    function loadRealtimeStrategy() {
      db.collection("guild_strategy").doc("main_order").onSnapshot(doc => {
        if (doc.exists) {
          currentStrategy = doc.data();
          document.getElementById("vanguardInput").value = currentStrategy.vanguard || "";
          if (currentStrategy.mapImageBase64) {
            document.getElementById("mapImage").src = currentStrategy.mapImageBase64;
            document.getElementById("mapImage").style.display = "block";
            document.getElementById("emptyMapText").style.display = "none";
          }
          renderGrid();
        }
      });
    }
    function renderGrid() {
      for (let i = 0; i < 1600; i++) {
        const cell = document.getElementById(`cell-${i}`);
        cell.className = "grid-cell" + (isAdmin ? " cell-admin" : "");
        cell.innerHTML = "";
        const data = currentStrategy.gridData[i];
        if (data && data.type !== "none") {
          cell.classList.add(data.type === "attack" ? "cell-attack" : "cell-defense");
          cell.innerHTML = `<div class="marker-icon">${data.type === "attack" ? "âš”ï¸" : "ğŸ›¡ï¸"}</div><div class="marker-count">${data.count}</div>`;
        }
      }
    }
    function applyCellData() {
      currentStrategy.gridData[editingCellIndex] = { 
        type: document.getElementById("cellType").value, 
        count: Number(document.getElementById("cellCount").value) 
      };
      document.getElementById("cellModal").style.display = "none";
      renderGrid();
    }
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const MAX_WIDTH = 1000;
          let width = img.width, height = img.height;
          if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
          canvas.width = width; canvas.height = height;
          canvas.getContext("2d").drawImage(img, 0, 0, width, height);
          currentStrategy.mapImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
          document.getElementById("mapImage").src = currentStrategy.mapImageBase64;
          document.getElementById("mapImage").style.display = "block";
          document.getElementById("emptyMapText").style.display = "none";
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
    async function saveStrategy() {
      currentStrategy.vanguard = document.getElementById("vanguardInput").value;
      try {
        await db.collection("guild_strategy").doc("main_order").set(currentStrategy);
        alert("ì‘ì „ ì €ì¥ ì™„ë£Œ!");
      } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
    }
  </script>
</body>
</html>