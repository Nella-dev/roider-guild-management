<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROIDER ê¸¸ë“œ - ì‘ì „ ì§€ë„</title>

  <link rel="stylesheet" href="header_standard.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>

  <style>
    body { margin: 0; background: radial-gradient(circle at top, #1b2333, #0f1015 60%); color: #e6e6e6; min-height: 100vh; }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 20px; }
    
    h2 { color: #f4c430; margin-top: 0; margin-bottom: 5px; font-weight: 800; }
    .desc { color: #aaa; margin-bottom: 20px; line-height: 1.5; font-size: 15px; font-weight: 500; }
    
    .card { background: #1c1f2a; border-radius: 12px; padding: 20px; border: 1px solid #2a3242; margin-bottom: 20px; }
    
    /* ì„ ë´‰ ë° ì»¨íŠ¸ë¡¤ ì˜ì—­ */
    .control-panel { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 6px; color: #bbb; font-weight: 800; }
    .input-group input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; font-family: inherit; font-size: 15px; }
    
    .admin-only { display: none; }
    .btn-upload { background: #444; color: #fff; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: inherit; }
    .btn-upload:hover { background: #555; }
    .btn-save-strategy { background: #ff5252; color: #fff; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 16px; font-family: inherit; width: 100%; margin-top: 10px; }
    .btn-save-strategy:hover { background: #e04848; }

    /* ğŸ’¡ ê·¸ë¦¬ë“œ ë§µ í•µì‹¬ CSS */
    .map-wrapper { position: relative; width: 100%; max-width: 1000px; background: #111; border: 2px solid #2a3242; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; }
    #mapImage { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
    
    /* 8x8 ì˜¤ë” ê·¸ë¦¬ë“œ ì„¤ì • */
    .grid-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); z-index: 10; }
    .grid-cell { border: 1px dashed rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; box-sizing: border-box; }
    
    /* ìƒíƒœë³„ ê·¸ë¦¬ë“œ ìƒ‰ìƒ ë° íš¨ê³¼ */
    .cell-attack { background: rgba(255, 50, 50, 0.5); border: 2px solid #ff5252; text-shadow: 1px 1px 3px #000; box-shadow: inset 0 0 10px rgba(255,0,0,0.5); }
    .cell-defense { background: rgba(50, 100, 255, 0.5); border: 2px solid #4dabf7; text-shadow: 1px 1px 3px #000; box-shadow: inset 0 0 10px rgba(0,100,255,0.5); }
    .cell-admin:hover { background: rgba(255, 255, 255, 0.2); cursor: pointer; }
    
    .marker-icon { font-size: 24px; font-weight: 900; }
    .marker-count { font-size: 14px; font-weight: 800; color: #fff; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; margin-top: 4px; }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1c1f2a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #f4c430; }
    .modal h3 { color: #f4c430; margin-top: 0; font-weight: 800; }
    .modal select, .modal input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-family: inherit; }
    .btn-apply { background: #f4c430; color: #111; }
    .btn-close { background: #444; color: #fff; }
  </style>
</head>
<body>

  <header>
    <div class="logo" id="appTitle" onclick="location.href='main.html'">ROIDER GUILD</div>
    <div class="user-box">
      <img id="userPhoto" src="https://via.placeholder.com/32" alt="profile" />
      <span id="userName">ë¡œë”©ì¤‘...</span>
      <span id="myRoleBadge" class="role-badge" style="display:none;"></span>
      <button id="langToggleBtn" class="logout" onclick="toggleLanguage()" style="color:#f4c430; border-color:#f4c430;">ğŸŒ EN</button>
      <button class="logout" onclick="logout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  
  <nav class="top-nav">
    <div class="nav-container">
      <a href="main.html" class="nav-link" data-i18n="menu_home">í™ˆ</a>
      <a href="notice.html" class="nav-link" data-i18n="menu_notice">ê³µì§€ì‚¬í•­</a>
      <a href="attendance.html" class="nav-link" data-i18n="menu_calendar">í™œë™ ìº˜ë¦°ë”</a>
      <a href="weekly.html" class="nav-link" data-i18n="menu_weekly">ì£¼ê°„ ê²°ì‚°</a>
      <a href="members.html" class="nav-link" data-i18n="menu_members">ê¸¸ë“œì› ëª©ë¡</a>
      <a href="strategy.html" class="nav-link active" data-i18n="menu_strategy">ì‘ì „ ì§€ë„</a>
      <a href="admin.html" class="nav-link" id="navAdminMenu" style="display: none; color: #ff5252;" data-i18n="menu_admin">ê¶Œí•œ ê´€ë¦¬</a>
    </div>
  </nav>

  <div class="wrap">
    <h2 data-i18n="str_title">ğŸ—ºï¸ ëŒ€í•­ì „ ì‘ì „ ì§€ë„</h2>
    <p class="desc" data-i18n="str_desc">ê·¸ë¦¬ë“œ ë§µì„ í™•ì¸í•˜ê³  ê¸¸ë“œì¥ì˜ ì˜¤ë”(ê³µê²©/ë°©ì–´/ì¸ì›)ì— ë§ì¶° í–‰ë™í•˜ì„¸ìš”.</p>

    <div class="card">
      <div class="control-panel">
        <div class="input-group">
          <label data-i18n="str_vanguard">âš”ï¸ ì„ ë´‰ ì§€ì •</label>
          <input type="text" id="vanguardInput" readonly placeholder="ì˜ˆ: ê¸¸ë“œì›A, ê¸¸ë“œì›B (ìƒë‹¨ ë£¨íŠ¸ ì§„í–‰)" data-i18n="str_vanguard_ph">
        </div>
        
        <div class="admin-only" id="adminControls">
          <input type="file" id="imageUpload" accept="image/png, image/jpeg" style="display:none;" onchange="handleImageUpload(event)">
          <button class="btn-upload" onclick="document.getElementById('imageUpload').click()" data-i18n="str_upload_map">ğŸ“ ì§€ë„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìµœì í™” ìë™ì ìš©)</button>
        </div>
      </div>

      <div class="map-wrapper" id="mapWrapper">
        <img id="mapImage" src="" style="display:none;">
        <span id="emptyMapText" style="color:#555; font-weight:800;" data-i18n="str_empty_map">ë“±ë¡ëœ ì‘ì „ ì§€ë„ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
        
        <div class="grid-overlay" id="gridOverlay">
          </div>
      </div>

      <button id="btnSaveStrategy" class="btn-save-strategy admin-only" onclick="saveStrategy()" data-i18n="str_btn_save">ğŸ’¾ ì‘ì „ ì €ì¥ ë° ê¸¸ë“œì›ì—ê²Œ ê³µìœ </button>
    </div>
  </div>

  <div class="modal-overlay" id="cellModal">
    <div class="modal">
      <h3 data-i18n="str_modal_title">í•´ë‹¹ êµ¬ì—­ ì˜¤ë” ì„¤ì •</h3>
      <label style="color:#aaa; font-size:13px; font-weight:800;" data-i18n="str_order_type">ì‘ì „ ëª…ë ¹</label>
      <select id="cellType">
        <option value="none" data-i18n="str_type_none">ë¬´ë°°ì¹˜ (ë¹„ì›Œë‘ )</option>
        <option value="attack" data-i18n="str_type_attack">ê³µê²© (Attack)</option>
        <option value="defense" data-i18n="str_type_defense">ë°©ì–´ (Defense)</option>
      </select>
      
      <label style="color:#aaa; font-size:13px; font-weight:800;" data-i18n="str_personnel">íˆ¬ì… ì¸ì› (ëª…)</label>
      <input type="number" id="cellCount" min="0" value="0">
      
      <div class="modal-btns">
        <button class="btn-close" onclick="closeCellModal()" data-i18n="str_btn_cancel">ì·¨ì†Œ</button>
        <button class="btn-apply" onclick="applyCellData()" data-i18n="str_btn_apply">ì ìš©</button>
      </div>
    </div>
  </div>

  <script>
    let isAdmin = false;
    let currentStrategy = {
      vanguard: "",
      mapImageBase64: "", // Firestore ìš©ëŸ‰ ì œí•œì„ ìœ„í•´ ì••ì¶•ëœ Base64 ì €ì¥
      gridData: {} // ì˜ˆ: { "12": { type: "attack", count: 3 } }
    };
    let editingCellIndex = -1;

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.replace("login.html");
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (docSnap.exists) {
        const role = docSnap.data().role;
        if (role === "admin" || role === "manager") {
          isAdmin = true;
          document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
          document.getElementById("vanguardInput").readOnly = false; // ê´€ë¦¬ìëŠ” ì…ë ¥ ê°€ëŠ¥
        }
        initGrid();
        loadRealtimeStrategy();
      }
    });

    // 1. 8x8 ê·¸ë¦¬ë“œ ìƒì„±
    function initGrid() {
      const grid = document.getElementById("gridOverlay");
      grid.innerHTML = "";
      for (let i = 0; i < 64; i++) {
        const cell = document.createElement("div");
        cell.className = "grid-cell";
        if (isAdmin) {
          cell.classList.add("cell-admin");
          cell.onclick = () => openCellModal(i);
        }
        cell.id = `cell-${i}`;
        grid.appendChild(cell);
      }
    }

    // 2. íŒŒì´ì–´ë² ì´ìŠ¤ì—ì„œ ì‹¤ì‹œê°„ ì‘ì „ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadRealtimeStrategy() {
      db.collection("guild_strategy").doc("main_order").onSnapshot(doc => {
        if (doc.exists) {
          currentStrategy = doc.data();
          if (!currentStrategy.gridData) currentStrategy.gridData = {};
          
          // ì„ ë´‰ëŒ€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë³¸ì¸ì´ ì…ë ¥ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
          if(document.activeElement !== document.getElementById("vanguardInput")) {
            document.getElementById("vanguardInput").value = currentStrategy.vanguard || "";
          }

          // ì´ë¯¸ì§€ ë Œë”ë§
          const imgEl = document.getElementById("mapImage");
          const emptyText = document.getElementById("emptyMapText");
          if (currentStrategy.mapImageBase64) {
            imgEl.src = currentStrategy.mapImageBase64;
            imgEl.style.display = "block";
            emptyText.style.display = "none";
          } else {
            imgEl.style.display = "none";
            emptyText.style.display = "block";
          }

          // ê·¸ë¦¬ë“œ ë Œë”ë§
          renderGrid();
        }
      });
    }

    // 3. ê·¸ë¦¬ë“œ ì¹¸ ë°ì´í„° í™”ë©´ì— ê·¸ë¦¬ê¸°
    function renderGrid() {
      for (let i = 0; i < 64; i++) {
        const cell = document.getElementById(`cell-${i}`);
        cell.className = "grid-cell" + (isAdmin ? " cell-admin" : ""); // ì´ˆê¸°í™”
        cell.innerHTML = "";

        const data = currentStrategy.gridData[i];
        if (data && data.type !== "none") {
          if (data.type === "attack") {
            cell.classList.add("cell-attack");
            cell.innerHTML = `<div class="marker-icon">âš”ï¸</div><div class="marker-count">${data.count}ëª…</div>`;
          } else if (data.type === "defense") {
            cell.classList.add("cell-defense");
            cell.innerHTML = `<div class="marker-icon">ğŸ›¡ï¸</div><div class="marker-count">${data.count}ëª…</div>`;
          }
        }
      }
    }

    // 4. ëª¨ë‹¬ ì œì–´ ë¡œì§ (ê´€ë¦¬ì ì „ìš©)
    function openCellModal(index) {
      editingCellIndex = index;
      const data = currentStrategy.gridData[index] || { type: "none", count: 0 };
      document.getElementById("cellType").value = data.type;
      document.getElementById("cellCount").value = data.count;
      document.getElementById("cellModal").style.display = "flex";
    }

    function closeCellModal() {
      document.getElementById("cellModal").style.display = "none";
    }

    function applyCellData() {
      const type = document.getElementById("cellType").value;
      const count = Number(document.getElementById("cellCount").value);
      
      currentStrategy.gridData[editingCellIndex] = { type, count };
      renderGrid(); // ì„ì‹œë¡œ í™”ë©´ì— ë¨¼ì € ê·¸ë¦¼
      closeCellModal();
    }

    // 5. ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° Canvas ë¦¬ì‚¬ì´ì§• ì••ì¶• (Firestore 1MB ìš©ëŸ‰ ì œí•œ íšŒí”¼ìš©)
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          
          // ê°€ë¡œ ê¸¸ì´ë¥¼ ìµœëŒ€ 1000pxë¡œ ì œí•œí•˜ì—¬ ìš©ëŸ‰ ìµœì í™”
          const MAX_WIDTH = 1000;
          let width = img.width;
          let height = img.height;

          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          // í™”ì§ˆ 70%ì˜ JPEG í¬ë§·ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ Base64 í…ìŠ¤íŠ¸ ìƒì„± (ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ)
          const base64String = canvas.toDataURL("image/jpeg", 0.7);
          
          currentStrategy.mapImageBase64 = base64String;
          document.getElementById("mapImage").src = base64String;
          document.getElementById("mapImage").style.display = "block";
          document.getElementById("emptyMapText").style.display = "none";
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // 6. ì‘ì„±í•œ ì „ì²´ ì˜¤ë” íŒŒì´ì–´ë² ì´ìŠ¤ì— ìµœì¢… ì €ì¥
    async function saveStrategy() {
      if (!isAdmin) return;
      
      currentStrategy.vanguard = document.getElementById("vanguardInput").value;
      currentStrategy.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

      try {
        await db.collection("guild_strategy").doc("main_order").set(currentStrategy);
        alert(i18n[currentLang]?.str_btn_save ? "ì‘ì „ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ ë° ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!" : "Strategy saved and shared successfully!");
      } catch (error) {
        alert("Error saving strategy: " + error.message);
      }
    }
  </script>
</body>
</html>